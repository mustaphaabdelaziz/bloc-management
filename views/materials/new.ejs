<% layout('layouts/boilerplate') %>
<!-- views/materials/new.ejs -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="material-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-plus-circle"></i>Nouveau Mat√©riau
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/materials" onsubmit="console.log('Form data:', new FormData(this)); return true;">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="category" class="form-label required-field">Cat√©gorie <span class="text-danger">*</span></label>
                                    <select name="category" id="category" class="form-select" required>
                                        <option value="">S√©lectionner une cat√©gorie</option>
                                        <option value="consumable" <%= material.category === 'consumable' ? 'selected' : '' %>>
                                            Consommable (jetable)
                                        </option>
                                        <option value="patient" <%= material.category === 'patient' ? 'selected' : '' %>>
                                            Mat√©riel patient (implant)
                                        </option>
                                    </select>
                                    <div class="form-text">
                                        <strong>Consommable :</strong> mat√©riel √† usage unique (gants, fils, etc.)<br>
                                        <strong>Patient :</strong> mat√©riel implant√© ou attach√© au patient (proth√®ses, plaques, etc.)
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="designation" class="form-label required-field">D√©signation <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="designation" name="designation" value="<%= material.designation || '' %>" required>
                            <div class="form-text">Nom complet du mat√©riau</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reference" class="form-label">R√©f√©rence</label>
                            <input type="text" class="form-control" id="reference" name="reference" value="<%= material.reference || '' %>">
                            <div class="form-text">Num√©ro de r√©f√©rence ou code du fabricant</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="priceHT" class="form-label required-field">Prix d'Achat HT (DA) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="priceHT" name="priceHT" value="<%= material.priceHT || '' %>" min="0" step="0.01" required>
                                    <div class="form-text">Prix d'achat de base (utilis√© si pas d'historique)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sellingMarkupPercent" class="form-label">Marge de Vente (%)</label>
                                    <input type="number" class="form-control" id="sellingMarkupPercent" name="sellingMarkupPercent" value="<%= material.sellingMarkupPercent || 0 %>" min="0" step="0.1">
                                    <div class="form-text">Pourcentage de marge appliqu√© au prix d'achat</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tva" class="form-label required-field">TVA <span class="text-danger">*</span></label>
                                    <select name="tva" id="tva" class="form-select" required>
                                        <option value="0" <%= material.tva === 0 ? 'selected' : '' %>>0% (Exon√©r√©)</option>
                                        <option value="0.09" <%= material.tva === 0.09 ? 'selected' : '' %>>9%</option>
                                        <option value="0.19" <%= !material.tva || material.tva === 0.19 ? 'selected' : '' %>>19% (Standard)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="unitOfMeasure" class="form-label required-field">Unit√© de mesure <span class="text-danger">*</span></label>
                                    <div class="custom-unit-select">
                                        <select class="form-select" name="unitOfMeasure" id="unitOfMeasure" style="display: none;" required>
                                            <option value="pi√®ce (Pce)" <%= material.unitOfMeasure === 'pi√®ce (Pce)' ? 'selected' : '' %>>pi√®ce (Pce)</option>
                                            <option value="bo√Æte (Bt)" <%= material.unitOfMeasure === 'bo√Æte (Bt)' ? 'selected' : '' %>>bo√Æte (Bt)</option>
                                            <option value="paquet (Paq)" <%= material.unitOfMeasure === 'paquet (Paq)' ? 'selected' : '' %>>paquet (Paq)</option>
                                            <option value="sachet (S)" <%= material.unitOfMeasure === 'sachet (S)' ? 'selected' : '' %>>sachet (S)</option>
                                            <option value="flacon (Fl)" <%= material.unitOfMeasure === 'flacon (Fl)' ? 'selected' : '' %>>flacon (Fl)</option>
                                            <option value="unit√© (U)" <%= material.unitOfMeasure === 'unit√© (U)' ? 'selected' : '' %>>unit√© (U)</option>
                                            <option value="m√®tre (m)" <%= material.unitOfMeasure === 'm√®tre (m)' ? 'selected' : '' %>>m√®tre (m)</option>
                                            <option value="litre (L)" <%= material.unitOfMeasure === 'litre (L)' ? 'selected' : '' %>>litre (L)</option>
                                            <option value="millilitre (mL)" <%= material.unitOfMeasure === 'millilitre (mL)' ? 'selected' : '' %>>millilitre (mL)</option>
                                            <option value="gramme (g)" <%= material.unitOfMeasure === 'gramme (g)' ? 'selected' : '' %>>gramme (g)</option>
                                            <option value="milligramme (mg)" <%= material.unitOfMeasure === 'milligramme (mg)' ? 'selected' : '' %>>milligramme (mg)</option>
                                            <option value="centim√®tre (cm)" <%= material.unitOfMeasure === 'centim√®tre (cm)' ? 'selected' : '' %>>centim√®tre (cm)</option>
                                            <option value="ampoule (Amp)" <%= material.unitOfMeasure === 'ampoule (Amp)' ? 'selected' : '' %>>ampoule (Amp)</option>
                                            <option value="seringue (Ser)" <%= material.unitOfMeasure === 'seringue (Ser)' ? 'selected' : '' %>>seringue (Ser)</option>
                                            <option value="tube (Tb)" <%= material.unitOfMeasure === 'tube (Tb)' ? 'selected' : '' %>>tube (Tb)</option>
                                            <option value="rouleau (Rl)" <%= material.unitOfMeasure === 'rouleau (Rl)' ? 'selected' : '' %>>rouleau (Rl)</option>
                                        </select>
                                        <div class="unit-select-trigger">
                                            <div class="unit-select-value">
                                                <span class="unit-icon">üì¶</span>
                                                <span id="unitText"><%= material.unitOfMeasure ? material.unitOfMeasure.toUpperCase() : 'S√âLECTIONNER...' %></span>
                                            </div>
                                            <i class="bi bi-chevron-down"></i>
                                        </div>
                                        <div class="unit-select-dropdown">
                                            <div class="unit-select-option" data-value="pi√®ce (Pce)">
                                                <span class="unit-option-icon">üîß</span>
                                                <span class="unit-option-text">pi√®ce (Pce)</span>
                                                <small class="unit-option-desc">instruments individuels</small>
                                            </div>
                                            <div class="unit-select-option" data-value="bo√Æte (Bt)">
                                                <span class="unit-option-icon">üì¶</span>
                                                <span class="unit-option-text">bo√Æte (Bt)</span>
                                                <small class="unit-option-desc">kits st√©riles</small>
                                            </div>
                                            <div class="unit-select-option" data-value="paquet (Paq)">
                                                <span class="unit-option-icon">üìã</span>
                                                <span class="unit-option-text">paquet (Paq)</span>
                                                <small class="unit-option-desc">compresses, gants</small>
                                            </div>
                                            <div class="unit-select-option" data-value="sachet (S)">
                                                <span class="unit-option-icon">üõçÔ∏è</span>
                                                <span class="unit-option-text">sachet (S)</span>
                                                <small class="unit-option-desc">emballage individuel</small>
                                            </div>
                                            <div class="unit-select-option" data-value="flacon (Fl)">
                                                <span class="unit-option-icon">üß¥</span>
                                                <span class="unit-option-text">flacon (Fl)</span>
                                                <small class="unit-option-desc">solutions, antiseptiques</small>
                                            </div>
                                            <div class="unit-select-option" data-value="unit√© (U)">
                                                <span class="unit-option-icon">1Ô∏è‚É£</span>
                                                <span class="unit-option-text">unit√© (U)</span>
                                                <small class="unit-option-desc">pi√®ce unique</small>
                                            </div>
                                            <div class="unit-select-option" data-value="m√®tre (m)">
                                                <span class="unit-option-icon">üìè</span>
                                                <span class="unit-option-text">m√®tre (m)</span>
                                                <small class="unit-option-desc">fils, tubulures</small>
                                            </div>
                                            <div class="unit-select-option" data-value="centim√®tre (cm)">
                                                <span class="unit-option-icon">üìê</span>
                                                <span class="unit-option-text">centim√®tre (cm)</span>
                                                <small class="unit-option-desc">petites longueurs</small>
                                            </div>
                                            <div class="unit-select-option" data-value="litre (L)">
                                                <span class="unit-option-icon">ü´ó</span>
                                                <span class="unit-option-text">litre (L)</span>
                                                <small class="unit-option-desc">liquides</small>
                                            </div>
                                            <div class="unit-select-option" data-value="millilitre (mL)">
                                                <span class="unit-option-icon">üíß</span>
                                                <span class="unit-option-text">millilitre (mL)</span>
                                                <small class="unit-option-desc">petits volumes</small>
                                            </div>
                                            <div class="unit-select-option" data-value="gramme (g)">
                                                <span class="unit-option-icon">‚öñÔ∏è</span>
                                                <span class="unit-option-text">gramme (g)</span>
                                                <small class="unit-option-desc">poudres</small>
                                            </div>
                                            <div class="unit-select-option" data-value="milligramme (mg)">
                                                <span class="unit-option-icon">üíä</span>
                                                <span class="unit-option-text">milligramme (mg)</span>
                                                <small class="unit-option-desc">m√©dicaments</small>
                                            </div>
                                            <div class="unit-select-option" data-value="ampoule (Amp)">
                                                <span class="unit-option-icon">üíâ</span>
                                                <span class="unit-option-text">ampoule (Amp)</span>
                                                <small class="unit-option-desc">m√©dicaments injectables</small>
                                            </div>
                                            <div class="unit-select-option" data-value="seringue (Ser)">
                                                <span class="unit-option-icon">ü©∫</span>
                                                <span class="unit-option-text">seringue (Ser)</span>
                                                <small class="unit-option-desc">seringues pr√©-remplies</small>
                                            </div>
                                            <div class="unit-select-option" data-value="tube (Tb)">
                                                <span class="unit-option-icon">üß™</span>
                                                <span class="unit-option-text">tube (Tb)</span>
                                                <small class="unit-option-desc">cr√®mes, pommades</small>
                                            </div>
                                            <div class="unit-select-option" data-value="rouleau (Rl)">
                                                <span class="unit-option-icon">üßª</span>
                                                <span class="unit-option-text">rouleau (Rl)</span>
                                                <small class="unit-option-desc">bandages, sparadrap</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-text">S√©lectionnez l'unit√© de mesure appropri√©e</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="specialty" class="form-label">Sp√©cialit√©s</label>
                                    <select name="specialty" id="specialty" class="form-select" multiple size="5">
                                        <option value="all" class="fw-bold text-primary" <%= material.appliesToAllSpecialties ? 'selected' : '' %>>
                                            üåê Toutes les sp√©cialit√©s
                                        </option>
                                        <% specialties.forEach(specialty => { %>
                                            <option value="<%= specialty._id %>" <%= (material.specialty && material.specialty.includes && material.specialty.includes(specialty._id.toString())) ? 'selected' : '' %>>
                                                <%= specialty.name %> (<%= specialty.code %>)
                                            </option>
                                        <% }); %>
                                    </select>
                                    <div class="form-text">
                                        <small class="text-muted">S√©lectionnez "Toutes les sp√©cialit√©s" pour un mat√©riau universel, ou choisissez des sp√©cialit√©s sp√©cifiques</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="brand" class="form-label">Marque</label>
                                    <input type="text" class="form-control" id="brand" name="brand" value="<%= material.brand || '' %>">
                                    <div class="form-text">Nom du fabricant ou de la marque</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="/materials" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i>Retour
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-save"></i>Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Update specialty field behavior based on category
document.getElementById('category').addEventListener('change', function() {
    const category = this.value;
    const specialtySelect = document.getElementById('specialty');
    const specialtyLabel = specialtySelect.previousElementSibling;
    const barcodeField = document.getElementById('barcodeField');

    if (category === 'consumable') {
        specialtyLabel.innerHTML = 'Sp√©cialit√©s <small class="text-muted">(optionnel pour les consommables)</small>';
        specialtySelect.required = false;
        if (barcodeField) barcodeField.style.display = 'none';
    } else if (category === 'patient') {
        specialtyLabel.innerHTML = 'Sp√©cialit√©s <small class="text-warning">(recommand√© pour les mat√©riels patient)</small>';
        specialtySelect.required = false;
        if (barcodeField) barcodeField.style.display = 'block';
    } else {
        specialtyLabel.innerHTML = 'Sp√©cialit√©s';
        specialtySelect.required = false;
        if (barcodeField) barcodeField.style.display = 'none';
    }
});

// Specialty select - handle "All" option exclusivity
document.getElementById('specialty').addEventListener('change', function() {
    const specialtySelect = this;
    const selectedOptions = Array.from(specialtySelect.selectedOptions);
    const allOption = specialtySelect.querySelector('option[value="all"]');
    
    // Check if "all" was just selected
    const allSelected = selectedOptions.some(opt => opt.value === 'all');
    
    if (allSelected && selectedOptions.length > 1) {
        // If "all" is selected along with others, keep only "all"
        Array.from(specialtySelect.options).forEach(opt => {
            opt.selected = opt.value === 'all';
        });
        updateCodePreview('ALL');
    } else if (allSelected) {
        updateCodePreview('ALL');
    } else if (selectedOptions.length === 0) {
        updateCodePreview('GEN');
    } else if (selectedOptions.length === 1) {
        const specialtyCode = selectedOptions[0].textContent.match(/\(([^)]+)\)/)?.[1] || 'GEN';
        updateCodePreview(specialtyCode.trim());
    } else {
        updateCodePreview('MUL');
    }
});

function updateCodePreview(specialtyCode) {
    const codeField = document.getElementById('code');
    if (codeField) {
        codeField.value = `MAT-${specialtyCode}-XXX (sera g√©n√©r√© automatiquement)`;
    }
}

// Unit of Measure Custom Select
document.addEventListener('DOMContentLoaded', function() {
    const customSelect = document.querySelector('.custom-unit-select');
    if (customSelect) {
        const selectTrigger = customSelect.querySelector('.unit-select-trigger');
        const dropdown = customSelect.querySelector('.unit-select-dropdown');
        const hiddenSelect = customSelect.querySelector('select');
        const unitText = customSelect.querySelector('#unitText');
        const unitIcon = customSelect.querySelector('.unit-icon');
        const options = customSelect.querySelectorAll('.unit-select-option');

        // Icon mapping
        const iconMap = {
            'pi√®ce (Pce)': 'üîß',
            'bo√Æte (Bt)': 'üì¶',
            'paquet (Paq)': 'üìã',
            'sachet (S)': 'üõçÔ∏è',
            'flacon (Fl)': 'üß¥',
            'unit√© (U)': '1Ô∏è‚É£',
            'm√®tre (m)': 'üìè',
            'centim√®tre (cm)': 'üìê',
            'litre (L)': 'ü´ó',
            'millilitre (mL)': 'üíß',
            'gramme (g)': '‚öñÔ∏è',
            'milligramme (mg)': 'üíä',
            'ampoule (Amp)': 'üíâ',
            'seringue (Ser)': 'ü©∫',
            'tube (Tb)': 'üß™',
            'rouleau (Rl)': 'üßª'
        };

        // Toggle dropdown
        selectTrigger.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.classList.toggle('open');
        });

        // Handle option selection
        options.forEach(option => {
            option.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                hiddenSelect.value = value;
                unitText.textContent = value.toUpperCase();
                unitIcon.textContent = iconMap[value] || 'üì¶';
                
                // Update selected state
                options.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                dropdown.classList.remove('open');
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!customSelect.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        // Initialize selected state from hidden select
        const currentValue = hiddenSelect.value;
        if (currentValue) {
            unitText.textContent = currentValue.toUpperCase();
            unitIcon.textContent = iconMap[currentValue] || 'üì¶';
            options.forEach(opt => {
                if (opt.getAttribute('data-value') === currentValue) {
                    opt.classList.add('selected');
                }
            });
        }
    }

    // Trigger category change to set initial state
    const categorySelect = document.getElementById('category');
    if (categorySelect && categorySelect.value) {
        categorySelect.dispatchEvent(new Event('change'));
    }

    // Initialize code preview
    const specialtySelect = document.getElementById('specialty');
    if (specialtySelect) {
        specialtySelect.dispatchEvent(new Event('change'));
    }
});
</script>

<style>
/* Custom Unit Select Styles */
.custom-unit-select {
    position: relative;
}

.unit-select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.unit-select-trigger:hover {
    border-color: #ffc107;
}

.unit-select-value {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.unit-icon {
    font-size: 1.25rem;
}

#unitText {
    font-weight: 600;
    font-size: 0.95rem;
    color: #333;
}

.unit-select-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

.unit-select-dropdown.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.unit-select-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-wrap: wrap;
}

.unit-select-option:hover {
    background: #fff8e1;
}

.unit-select-option.selected {
    background: #ffc107;
    color: white;
}

.unit-select-option.selected .unit-option-desc {
    color: rgba(255,255,255,0.8);
}

.unit-option-icon {
    font-size: 1.25rem;
}

.unit-option-text {
    font-weight: 500;
    font-size: 0.95rem;
    text-transform: capitalize;
}

.unit-option-desc {
    width: 100%;
    margin-left: 2.5rem;
    font-size: 0.75rem;
    color: #666;
}

/* Specialty select styling */
#specialty option[value="all"] {
    background-color: #e3f2fd;
    font-weight: bold;
}
</style>