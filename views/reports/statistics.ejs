<% layout('layouts/boilerplate') %>
<!-- views/reports/statistics.ejs -->
<style>
/* Modern Statistics Dashboard Styles */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    --danger-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    --light-bg: #f8f9fa;
    --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
    --card-shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    background: var(--light-bg);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Header Section */
.stats-header {
    background: var(--primary-gradient);
    border-radius: var(--border-radius);
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
    box-shadow: var(--card-shadow);
}

.stats-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    letter-spacing: -0.025em;
}

.stats-header p {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 0;
}

/* Filter Section */
.filter-section {
    background: white;
    border-radius: var(--border-radius);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(0,0,0,0.05);
}

.filter-form .form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
}

.filter-form .form-control {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: var(--transition);
}

.filter-form .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-btn {
    background: var(--primary-gradient);
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    color: white;
    transition: var(--transition);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

/* KPI Cards */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.kpi-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(0,0,0,0.05);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--card-shadow-hover);
}

.kpi-card:nth-child(2)::before { background: var(--secondary-gradient); }
.kpi-card:nth-child(3)::before { background: var(--success-gradient); }
.kpi-card:nth-child(4)::before { background: var(--warning-gradient); }

.kpi-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    margin-bottom: 1rem;
}

.kpi-card:nth-child(1) .kpi-icon { background: var(--primary-gradient); }
.kpi-card:nth-child(2) .kpi-icon { background: var(--secondary-gradient); }
.kpi-card:nth-child(3) .kpi-icon { background: var(--success-gradient); }
.kpi-card:nth-child(4) .kpi-icon { background: var(--warning-gradient); }

.kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
    letter-spacing: -0.025em;
}

.kpi-label {
    font-size: 0.95rem;
    color: #6b7280;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Charts Section */
.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
    transition: var(--transition);
}

.chart-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
}

.chart-header {
    background: var(--dark-gradient);
    color: white;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.chart-header h5 {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chart-body {
    padding: 1.5rem;
}

.chart-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #374151;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

/* Status Stats Grid */
.status-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.status-stat-card {
    background: white;
    border-radius: 8px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: var(--transition);
    border: 1px solid #e5e7eb;
}

.status-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.status-stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.status-stat-content {
    flex-grow: 1;
}

.status-stat-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.status-stat-label {
    font-size: 0.85rem;
    color: #6b7280;
    font-weight: 500;
}

/* Performance Section */
.performance-section {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.performance-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.performance-header {
    background: var(--success-gradient);
    color: white;
    padding: 1.5rem;
    text-align: center;
}

.performance-header h5 {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
}

.performance-body {
    padding: 2rem;
    text-align: center;
}

.duration-value {
    font-size: 3rem;
    font-weight: 700;
    color: #059669;
    margin-bottom: 0.5rem;
}

.duration-label {
    color: #6b7280;
    font-size: 0.95rem;
    font-weight: 500;
}

.duration-stats {
    display: flex;
    justify-content: space-around;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
}

.duration-stat {
    text-align: center;
}

.duration-stat .value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #374151;
    display: block;
}

.duration-stat .label {
    color: #6b7280;
    font-size: 0.85rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Summary Table */
.summary-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.summary-header {
    background: var(--info-gradient);
    color: #1f2937;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.summary-header h5 {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.summary-table {
    width: 100%;
}

.summary-table th {
    background: #f9fafb;
    color: #374151;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.summary-table td {
    padding: 1rem;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: middle;
}

.summary-table tr:hover {
    background: #f9fafb;
}

.metric-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.metric-name {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.25rem;
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1f2937;
}

.metric-desc {
    color: #6b7280;
    font-size: 0.9rem;
}

/* Data Table */
.data-section {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.data-header {
    background: var(--warning-gradient);
    color: #1f2937;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.data-header h5 {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: #f9fafb;
    color: #374151;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 1rem 0.75rem;
    text-align: left;
    border-bottom: 2px solid #e5e7eb;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.data-table td {
    padding: 1rem 0.75rem;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: middle;
}

.data-table tr:hover {
    background: #f9fafb;
}

.patient-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.patient-name {
    font-weight: 600;
    color: #374151;
}

.patient-code {
    font-size: 0.8rem;
    color: #6b7280;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Loading States */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: #6b7280;
}

.loading-spinner i {
    font-size: 2rem;
    margin-bottom: 1rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Empty States */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: #6b7280;
    text-align: center;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h6 {
    color: #374151;
    margin-bottom: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .stats-header {
        padding: 1.5rem;
    }

    .stats-header h1 {
        font-size: 2rem;
    }

    .kpi-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .charts-section {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .performance-section {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .kpi-card {
        padding: 1.5rem;
    }

    .kpi-value {
        font-size: 2rem;
    }

    .duration-value {
        font-size: 2.5rem;
    }

    .summary-table,
    .data-table {
        font-size: 0.85rem;
    }

    .summary-table th,
    .summary-table td,
    .data-table th,
    .data-table td {
        padding: 0.75rem 0.5rem;
    }
}

/* Print Styles */
@media print {
    body {
        background: white !important;
    }

    .stats-header,
    .filter-section,
    .kpi-card,
    .chart-card,
    .performance-card,
    .summary-card,
    .data-section {
        box-shadow: none !important;
        border: 1px solid #e5e7eb !important;
    }

    .filter-section {
        display: none !important;
    }
}
</style>

<!-- Header Section -->
<div class="stats-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1>üìä Statistiques G√©n√©rales</h1>
            <p>Tableaux de bord et analyses d'activit√© globale</p>
        </div>
        <button onclick="window.print()" class="report-btn btn-outline-primary">
            <i class="bi bi-printer me-2"></i>Imprimer
        </button>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <form method="GET" class="filter-form row g-3">
        <div class="col-md-5">
            <label class="form-label">üìÖ Date d√©but</label>
            <input type="date" name="startDate" class="form-control" value="<%= filters.startDate %>">
        </div>
        <div class="col-md-5">
            <label class="form-label">üìÖ Date fin</label>
            <input type="date" name="endDate" class="form-control" value="<%= filters.endDate %>">
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="report-btn btn-primary w-100">
                <i class="bi bi-funnel me-1"></i>Filtrer
            </button>
        </div>
    </form>
</div>

<!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="kpi-icon">
            <i class="bi bi-scissors"></i>
        </div>
        <div class="kpi-value"><%= surgeriesByStatus.reduce((sum, item) => sum + item.count, 0) %></div>
        <div class="kpi-label">Chirurgies totales</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-icon">
            <i class="bi bi-award"></i>
        </div>
        <div class="kpi-value"><%= surgeriesBySpecialty.length %></div>
        <div class="kpi-label">Sp√©cialit√©s actives</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-icon">
            <i class="bi bi-clock"></i>
        </div>
        <div class="kpi-value">
            <% if (avgDurations.avgDuration) { %>
                <%= Math.round(avgDurations.avgDuration) %>min
            <% } else { %>
                -
            <% } %>
        </div>
        <div class="kpi-label">Dur√©e moyenne</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-icon">
            <i class="bi bi-calendar-day"></i>
        </div>
        <div class="kpi-value">
            <%
            const totalDays = Math.ceil((new Date(filters.endDate) - new Date(filters.startDate)) / (1000 * 60 * 60 * 24)) || 1;
            const dailyAvg = Math.round(surgeriesByStatus.reduce((sum, item) => sum + item.count, 0) / totalDays);
            %>
            <%= dailyAvg %>
        </div>
        <div class="kpi-label">Chirurgies/jour</div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-section">
    <!-- Status Distribution -->
    <div class="chart-card">
        <div class="chart-header">
            <h5><i class="bi bi-bar-chart-line"></i>R√©partition par Statut</h5>
        </div>
        <div class="chart-body">
            <% if (surgeriesByStatus.length > 0) { %>
                <div class="status-stats-grid">
                    <% surgeriesByStatus.forEach((status, index) => { %>
                        <% let statusLabel = status._id; %>
                        <% let statusColor = '#6b7280'; %>
                        <% let statusIcon = 'circle'; %>
                        <% if (status._id === 'planned') { statusLabel = 'Planifi√©es'; statusColor = '#f59e0b'; statusIcon = 'calendar-check'; } %>
                        <% if (status._id === 'in-progress') { statusLabel = 'En cours'; statusColor = '#3b82f6'; statusIcon = 'play-circle'; } %>
                        <% if (status._id === 'completed') { statusLabel = 'Termin√©es'; statusColor = '#10b981'; statusIcon = 'check-circle'; } %>
                        <% if (status._id === 'urgent') { statusLabel = 'Urgentes'; statusColor = '#ef4444'; statusIcon = 'exclamation-triangle'; } %>
                        <% if (status._id === 'cancelled') { statusLabel = 'Annul√©es'; statusColor = '#6b7280'; statusIcon = 'x-circle'; } %>
                        <div class="status-stat-card" style="border-left: 4px solid <%= statusColor %>">
                            <div class="status-stat-icon" style="background-color: <%= statusColor %>20; color: <%= statusColor %>">
                                <i class="bi bi-<%= statusIcon %>"></i>
                            </div>
                            <div class="status-stat-content">
                                <div class="status-stat-value" style="color: <%= statusColor %>"><%= status.count %></div>
                                <div class="status-stat-label"><%= statusLabel %></div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <i class="bi bi-bar-chart-line"></i>
                    <h6>Aucune donn√©e disponible</h6>
                    <p>Les statistiques appara√Ætront ici une fois que des chirurgies seront enregistr√©es.</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Performance Section -->
<div class="performance-section">
    <!-- Duration Analysis -->
    <div class="performance-card">
        <div class="performance-header">
            <h5><i class="bi bi-stopwatch"></i>Analyse des Dur√©es</h5>
        </div>
        <div class="performance-body">
            <% if (avgDurations.avgDuration) { %>
                <div class="duration-value"><%= Math.round(avgDurations.avgDuration) %></div>
                <div class="duration-label">Minutes (moyenne)</div>

                <div class="duration-stats">
                    <div class="duration-stat">
                        <span class="value text-primary"><%= Math.round(avgDurations.minDuration) %></span>
                        <span class="label">Minimum</span>
                    </div>
                    <div class="duration-stat">
                        <span class="value text-warning"><%= Math.round(avgDurations.maxDuration) %></span>
                        <span class="label">Maximum</span>
                    </div>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <i class="bi bi-stopwatch"></i>
                    <h6>Aucune dur√©e enregistr√©e</h6>
                    <p>Les statistiques de dur√©e appara√Ætront ici une fois que des chirurgies avec dur√©e seront enregistr√©es.</p>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Time Evolution -->
    <div class="performance-card">
        <div class="chart-header">
            <h5><i class="bi bi-calendar-week"></i>√âvolution Temporelle</h5>
        </div>
        <div class="chart-body">
            <canvas id="timeChart" width="400" height="250"></canvas>
        </div>
    </div>
</div>

<!-- Summary Table -->
<div class="summary-card">
    <div class="summary-header">
        <h5><i class="bi bi-table"></i>R√©sum√© de la P√©riode</h5>
    </div>
    <div class="table-responsive">
        <table class="summary-table">
            <thead>
                <tr>
                    <th>M√©trique</th>
                    <th>Valeur</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <div class="metric-icon" style="background: var(--primary-gradient); color: white;">
                            <i class="bi bi-scissors"></i>
                        </div>
                        <div class="metric-name">Total Chirurgies</div>
                    </td>
                    <td class="metric-value"><%= surgeriesByStatus.reduce((sum, item) => sum + item.count, 0) %></td>
                    <td class="metric-desc">Nombre total d'interventions dans la p√©riode</td>
                </tr>
                <tr>
                    <td>
                        <div class="metric-icon" style="background: var(--success-gradient); color: white;">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="metric-name">Taux de R√©ussite</div>
                    </td>
                    <td class="metric-value">
                        <%
                        const totalSurgeries = surgeriesByStatus.reduce((sum, item) => sum + item.count, 0);
                        const completedSurgeries = surgeriesByStatus.find(s => s._id === 'completed')?.count || 0;
                        const successRate = totalSurgeries > 0 ? Math.round((completedSurgeries / totalSurgeries) * 100) : 0;
                        %>
                        <%= successRate %>%
                    </td>
                    <td class="metric-desc">Pourcentage de chirurgies termin√©es avec succ√®s</td>
                </tr>
                <tr>
                    <td>
                        <div class="metric-icon" style="background: var(--danger-gradient); color: white;">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div class="metric-name">Chirurgies Urgentes</div>
                    </td>
                    <td class="metric-value">
                        <% const urgentSurgeries = surgeriesByStatus.find(s => s._id === 'urgent')?.count || 0; %>
                        <%= urgentSurgeries %>
                    </td>
                    <td class="metric-desc">Nombre d'interventions en urgence</td>
                </tr>
                <% if (avgDurations.avgDuration) { %>
                <tr>
                    <td>
                        <div class="metric-icon" style="background: var(--info-gradient); color: #374151;">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="metric-name">Dur√©e Moyenne</div>
                    </td>
                    <td class="metric-value"><%= Math.round(avgDurations.avgDuration) %> min</td>
                    <td class="metric-desc">Temps moyen d'intervention</td>
                </tr>
                <tr>
                    <td>
                        <div class="metric-icon" style="background: var(--warning-gradient); color: #374151;">
                            <i class="bi bi-speedometer"></i>
                        </div>
                        <div class="metric-name">Efficacit√©</div>
                    </td>
                    <td class="metric-value">
                        <%
                        const efficiency = avgDurations.avgDuration <= 120 ? 'Excellente' :
                                         avgDurations.avgDuration <= 180 ? 'Bonne' : '√Ä am√©liorer';
                        %>
                        <%= efficiency %>
                    </td>
                    <td class="metric-desc">√âvaluation bas√©e sur la dur√©e moyenne</td>
                </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<!-- Data Table -->
<div class="data-section mt-4">
    <div class="data-header">
        <h5><i class="bi bi-list-check"></i>D√©tail des Chirurgies (<%= typeof totalSurgeries !== 'undefined' ? totalSurgeries : surgeriesByStatus.reduce((sum, item) => sum + item.count, 0) %> total)</h5>
    </div>
    <div class="table-responsive">
        <% if (typeof detailedSurgeries !== 'undefined' && detailedSurgeries && detailedSurgeries.length > 0) { %>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Patient</th>
                        <th>Chirurgien</th>
                        <th>Prestation</th>
                        <th>Date</th>
                        <th>Statut</th>
                        <th>Dur√©e</th>
                    </tr>
                </thead>
                <tbody id="surgeries-tbody">
                    <% detailedSurgeries.forEach(surgery => { %>
                        <tr>
                            <td><strong><%= surgery.code %></strong></td>
                            <td>
                                <% if (surgery.patient) { %>
                                    <div class="patient-info">
                                        <div class="patient-name"><%= surgery.patient.firstName %> <%= surgery.patient.lastName %></div>
                                        <div class="patient-code"><%= surgery.patient.code %></div>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">N/A</span>
                                <% } %>
                            </td>
                            <td>
                                <% if (surgery.surgeon) { %>
                                    Dr. <%= surgery.surgeon.lastName %> <%= surgery.surgeon.firstName %>
                                <% } else { %>
                                    <span class="text-muted">N/A</span>
                                <% } %>
                            </td>
                            <td>
                                <% if (surgery.prestation) { %>
                                    <div class="patient-info">
                                        <div class="patient-name"><%= surgery.prestation.designation %></div>
                                        <div class="patient-code"><%= surgery.prestation.duration %> min</div>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">N/A</span>
                                <% } %>
                            </td>
                            <td><%= moment(surgery.incisionTime).format('DD/MM/YYYY HH:mm') %></td>
                            <td>
                                <% let statusLabel = surgery.status; %>
                                <% let statusClass = 'secondary'; %>
                                <% if (surgery.status === 'planned') { statusLabel = 'Planifi√©e'; statusClass = 'warning'; } %>
                                <% if (surgery.status === 'in-progress') { statusLabel = 'En cours'; statusClass = 'primary'; } %>
                                <% if (surgery.status === 'completed') { statusLabel = 'Termin√©e'; statusClass = 'success'; } %>
                                <% if (surgery.status === 'urgent') { statusLabel = 'Urgente'; statusClass = 'danger'; } %>
                                <% if (surgery.status === 'cancelled') { statusLabel = 'Annul√©e'; statusClass = 'secondary'; } %>
                                <span class="status-badge bg-<%= statusClass %>"><%= statusLabel %></span>
                            </td>
                            <td>
                                <% if (surgery.closingIncisionTime) { %>
                                    <% const duration = Math.round((new Date(surgery.closingIncisionTime) - new Date(surgery.incisionTime)) / 60000); %>
                                    <%= duration %> min
                                <% } else { %>
                                    <span class="text-muted">-</span>
                                <% } %>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>

            <% if (typeof hasMore !== 'undefined' && hasMore) { %>
                <div class="text-center mt-4" id="loading-indicator">
                    <div class="loading-spinner">
                        <i class="bi bi-arrow-repeat"></i>
                        <p class="mb-0">Chargement de plus de donn√©es...</p>
                    </div>
                </div>

                <div class="text-center mt-3 d-none" id="load-more-container">
                    <button class="report-btn btn-outline-primary" id="load-more-btn">
                        <i class="bi bi-arrow-down-circle me-2"></i>Charger plus de chirurgies
                    </button>
                </div>
            <% } %>
        <% } else { %>
            <div class="empty-state">
                <i class="bi bi-table"></i>
                <h6>Aucune chirurgie trouv√©e</h6>
                <p>Les d√©tails des chirurgies appara√Ætront ici une fois que des interventions seront enregistr√©es pour cette p√©riode.</p>
            </div>
        <% } %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Donn√©es depuis le serveur
    const statusData = <%- JSON.stringify(surgeriesByStatus || []) %>;
    const startDateStr = '<%- filters.startDate %>';
    const endDateStr = '<%- filters.endDate %>';

    // Couleurs pour les graphiques
    const colors = ['#ffc107', '#007bff', '#28a745', '#dc3545', '#6c757d', '#17a2b8', '#fd7e14'];

    // Variables pour le chargement
    let currentPage = <%- JSON.stringify(currentPage || 1) %>;
    let isLoading = false;
    let hasMore = <%- JSON.stringify(typeof hasMore !== 'undefined' ? hasMore : false) %>;

    // Graphique temporel (simulation - vous pouvez remplacer par de vraies donn√©es)
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    const days = [];
    const surgeryCount = [];

    // G√©n√©rer des donn√©es simul√©es pour la p√©riode
    const startDate = new Date('<%- filters.startDate %>');
    const endDate = new Date('<%- filters.endDate %>');
    const totalSurgeries = statusData.reduce((sum, item) => sum + item.count, 0);

    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        days.push(d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }));
        // Distribution al√©atoire simul√©e (remplacer par vraies donn√©es)
        surgeryCount.push(Math.floor(Math.random() * 8) + 1);
    }

    new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: days.slice(-14), // Derniers 14 jours
            datasets: [{
                label: 'Chirurgies par jour',
                data: surgeryCount.slice(-14),
                borderColor: 'rgba(255, 193, 7, 1)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Fonction pour charger plus de chirurgies
    async function loadMoreSurgeries() {
        if (isLoading || !hasMore) return;

        isLoading = true;
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadMoreContainer = document.getElementById('load-more-container');

        if (loadingIndicator) loadingIndicator.classList.remove('d-none');
        if (loadMoreContainer) loadMoreContainer.classList.add('d-none');

        try {
            const response = await fetch(`/reports/statistics?page=${currentPage + 1}&startDate=${startDateStr}&endDate=${endDateStr}`, {
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.ok) {
                const data = await response.json();
                const tbody = document.getElementById('surgeries-tbody');

                data.surgeries.forEach(surgery => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${surgery.code}</strong></td>
                        <td>
                            ${surgery.patient ?
                                `<div class="patient-info">
                                    <div class="patient-name">${surgery.patient.firstName} ${surgery.patient.lastName}</div>
                                    <div class="patient-code">${surgery.patient.code}</div>
                                </div>` :
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                        <td>
                            ${surgery.surgeon ?
                                `Dr. ${surgery.surgeon.lastName} ${surgery.surgeon.firstName}` :
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                        <td>
                            ${surgery.prestation ?
                                `<div class="patient-info">
                                    <div class="patient-name">${surgery.prestation.designation}</div>
                                    <div class="patient-code">${surgery.prestation.duration} min</div>
                                </div>` :
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                        <td>${new Date(surgery.incisionTime).toLocaleDateString('fr-FR')} ${new Date(surgery.incisionTime).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</td>
                        <td>
                            ${(() => {
                                let statusLabel = surgery.status;
                                let statusClass = 'secondary';
                                if (surgery.status === 'planned') { statusLabel = 'Planifi√©e'; statusClass = 'warning'; }
                                if (surgery.status === 'in-progress') { statusLabel = 'En cours'; statusClass = 'primary'; }
                                if (surgery.status === 'completed') { statusLabel = 'Termin√©e'; statusClass = 'success'; }
                                if (surgery.status === 'urgent') { statusLabel = 'Urgente'; statusClass = 'danger'; }
                                if (surgery.status === 'cancelled') { statusLabel = 'Annul√©e'; statusClass = 'secondary'; }
                                return `<span class="status-badge bg-${statusClass}">${statusLabel}</span>`;
                            })()}
                        </td>
                        <td>
                            ${surgery.closingIncisionTime ?
                                `${Math.round((new Date(surgery.closingIncisionTime) - new Date(surgery.incisionTime)) / 60000)} min` :
                                '<span class="text-muted">-</span>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                hasMore = data.hasMore;
                currentPage = data.page;

                if (!hasMore) {
                    if (loadingIndicator) loadingIndicator.classList.add('d-none');
                    if (loadMoreContainer) loadMoreContainer.classList.add('d-none');
                } else {
                    if (loadingIndicator) loadingIndicator.classList.add('d-none');
                    if (loadMoreContainer) loadMoreContainer.classList.remove('d-none');
                }
            } else {
                console.error('Erreur lors du chargement des donn√©es');
                if (loadingIndicator) loadingIndicator.classList.add('d-none');
                if (loadMoreContainer) loadMoreContainer.classList.remove('d-none');
            }
        } catch (error) {
            console.error('Erreur:', error);
            if (loadingIndicator) loadingIndicator.classList.add('d-none');
            if (loadMoreContainer) loadMoreContainer.classList.remove('d-none');
        } finally {
            isLoading = false;
        }
    }

    // Configuration du chargement manuel
    if (hasMore) {
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', loadMoreSurgeries);
        }
    }

    // Animation des chiffres au scroll
    const animateNumbers = () => {
        document.querySelectorAll('.kpi-value').forEach(element => {
            const target = parseInt(element.textContent.replace(/\D/g, ''));
            if (!target) return;

            let current = 0;
            const increment = target / 50;
            const timer = setInterval(() => {
                current += increment;
                element.textContent = Math.floor(current);
                if (current >= target) {
                    element.textContent = target;
                    clearInterval(timer);
                }
            }, 30);
        });
    };

    // Observer pour d√©clencher l'animation
    const animationObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                animateNumbers();
                animationObserver.unobserve(entry.target);
            }
        });
    });

    document.querySelectorAll('.kpi-card').forEach(el => {
        animationObserver.observe(el);
    });
});
</script>