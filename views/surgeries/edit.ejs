<% layout('layouts/boilerplate') %>
<!-- views/surgeries/edit.ejs -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="surgery-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-pencil"></i>Modifier Chirurgie
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="/surgeries/<%= surgery._id %>?_method=PUT" id="surgeryForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="code" class="form-label">Code (Auto-généré)</label>
                                    <input type="text" class="form-control" id="code" name="code" value="<%= surgery.code %>" readonly disabled>
                                    <div class="form-text">Le code ne peut pas être modifié</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status" class="form-label required-field">Statut</label>
                                    <select name="status" id="status" class="form-select" required>
                                        <option value="planned" <%= surgery.status === 'planned' ? 'selected' : '' %>>Planifiée</option>
                                        <option value="urgent" <%= surgery.status === 'urgent' ? 'selected' : '' %>>Urgente</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="patient" class="form-label required-field">Patient</label>
                            <select name="patient" id="patient" class="form-select" required>
                                <option value="">Sélectionner un patient</option>
                                <% patients.forEach(patient => { %>
                                    <option value="<%= patient._id %>" <%= surgery.patient._id.toString() === patient._id.toString() ? 'selected' : '' %>>
                                        <%= patient.firstName %> <%= patient.lastName %> - <%= patient.code %>
                                    </option>
                                <% }); %>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="surgeon" class="form-label required-field">Chirurgien</label>
                                    <select name="surgeon" id="surgeon" class="form-select" required>
                                        <option value="">Sélectionner un chirurgien</option>
                                        <% surgeons.forEach(surgeon => { %>
                                            <option value="<%= surgeon._id %>"
                                                    data-contract="<%= surgeon.contractType %>"
                                                    <%= surgery.surgeon._id.toString() === surgeon._id.toString() ? 'selected' : '' %>>
                                                Dr. <%= surgeon.firstName %> <%= surgeon.lastName %> - <%= surgeon.specialty.name %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="prestation" class="form-label required-field">Prestation</label>
                                    <select name="prestation" id="prestation" class="form-select" required>
                                        <option value="">Sélectionner une prestation</option>
                                        <% prestations.forEach(prestation => { %>
                                            <option value="<%= prestation._id %>"
                                                    data-duration="<%= prestation.duration %>"
                                                    data-price="<%= prestation.priceHT %>"
                                                    <%= surgery.prestation._id.toString() === prestation._id.toString() ? 'selected' : '' %>>
                                                <%= prestation.designation %> - <%= prestation.specialty.name %> (<%= prestation.duration %> min)
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="beginDateTime" class="form-label required-field">Date et heure de début</label>
                                    <input type="datetime-local" class="form-control" id="beginDateTime" name="beginDateTime"
                                           value="<%= surgery.beginDateTime ? moment(surgery.beginDateTime).format('YYYY-MM-DDTHH:mm') : '' %>" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endDateTime" class="form-label">Date et heure de fin</label>
                                    <input type="datetime-local" class="form-control" id="endDateTime" name="endDateTime"
                                           value="<%= surgery.endDateTime ? moment(surgery.endDateTime).format('YYYY-MM-DDTHH:mm') : '' %>">
                                    <div class="form-text">Optionnel - permet le calcul automatique de la durée</div>
                                </div>
                            </div>
                        </div>

                        <% if (canEditSurgeryFinancials) { %>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="adjustedPrice" class="form-label">Prix ajusté (DA)</label>
                                    <input type="number" class="form-control" id="adjustedPrice" name="adjustedPrice"
                                           value="<%= surgery.adjustedPrice || '' %>" min="0" step="0.01" placeholder="Prix spécifique (optionnel)">
                                    <div class="form-text">Prix de base: <span id="basePrice">
                                        <% if (surgery.prestation && surgery.prestation.priceHT && !isNaN(parseFloat(surgery.prestation.priceHT))) {%>
                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(parseFloat(surgery.prestation.priceHT)) %>
                                        <% } else { %>
                                            Prix non disponible
                                        <% } %>
                                    </span></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="applyExtraFees" name="applyExtraFees" <%= surgery.applyExtraFees ? 'checked' : '' %>>
                                        <label class="form-check-label" for="applyExtraFees">
                                            Appliquer des frais supplémentaires
                                        </label>
                                    </div>
                                    <div class="form-text">Si activé, des frais additionnels seront appliqués en cas de dépassement</div>
                                </div>
                            </div>
                        </div>
                        <% } %>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes et Observations</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"
                                      placeholder="Ajouter des notes spécifiques à cette chirurgie..."><%= surgery.notes || '' %></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="/surgeries/<%= surgery._id %>" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i>Annuler
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-save"></i>Sauvegarder
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Update base price when prestation changes
document.addEventListener('DOMContentLoaded', function() {
    const prestationSelect = document.getElementById('prestation');
    const basePriceDisplay = document.getElementById('basePrice');

    if (prestationSelect && basePriceDisplay) {
        prestationSelect.addEventListener('change', function() {
            const selectedOption = this.selectedOptions[0];
            if (selectedOption && selectedOption.value) {
                const basePriceValue = selectedOption.getAttribute('data-price');
                if (basePriceValue && !isNaN(parseFloat(basePriceValue))) {
                    const basePrice = parseFloat(basePriceValue);
                    basePriceDisplay.textContent = new Intl.NumberFormat('fr-DZ', {
                        style: 'currency',
                        currency: 'DZD'
                    }).format(basePrice);
                } else {
                    basePriceDisplay.textContent = 'Prix non disponible';
                }
            } else {
                basePriceDisplay.textContent = 'Sélectionnez une prestation';
            }
        });
    }
});
</script>