<% layout('layouts/boilerplate') %>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Surgery Header with Actions -->
            <div class="card surgery-card mb-4">
                <div class="card-header bg-primary text-white surgery-header">
                    <div>
                        <h4 class="mb-2">
                            <i class="fas fa-clipboard me-2"></i>
                            Détails de la Chirurgie
                            <% if (surgery.statusLifecycle === 'closed') { %>
                                <span class="badge bg-success ms-2">
                                    <i class="bi bi-lock-fill"></i> Clôturée
                                </span>
                            <% } %>
                        </h4>
                    </div>
                    <div class="d-flex gap-2 ms-auto ">
                        <% if (surgery.statusLifecycle !== 'closed' || permissions.canEditClosedSurgeries) { %>
                            <a href="/surgeries/<%= surgery._id %>/edit" class="btn btn-light btn-sm" title="Modifier la chirurgie">
                                <i class="fas fa-edit me-1"></i>Modifier
                            </a>
                        <% } %>
                        <% if (permissions.canCloseSurgeries) { %>
                            <% if (surgery.statusLifecycle === 'editable') { %>
                                <form method="POST" action="/surgeries/<%= surgery._id %>/close" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Êtes-vous-vous sûr de vouloir clôturer cette chirurgie? Elle ne pourra plus être modifiée.')" title="Clôturer la chirurgie">
                                        <i class="bi bi-lock-fill me-1"></i>Clôturer
                                    </button>
                                </form>
                            <% } else if (surgery.statusLifecycle === 'closed') { %>
                                <form method="POST" action="/surgeries/<%= surgery._id %>/reopen" class="d-inline">
                                    <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('êtes-vous sûr de vouloir rouvrir cette chirurgie?')" title="RRouvrir la chirurgie">
                                        <i class="bi bi-unlock-fill me-1"></i>Rouvrir
                                    </button>
                                </form>
                            <% } %>
                        <% } %>
                        <a href="/surgeries" class="btn btn-light btn-sm" title="Retour à la liste">
                            <i class="fas fa-arrow-left me-1"></i>Retour
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Code:</strong> <%= surgery.code %></p>
                            <p class="mb-2"><strong>Patient:</strong> <%= surgery.patient ? `${surgery.patient.firstName} ${surgery.patient.lastName}` : 'N/A' %></p>
                            <p class="mb-2"><strong>Chirurgien:</strong> Dr. <%= surgery.surgeon ? `${surgery.surgeon.lastName} ${surgery.surgeon.firstName}` : 'N/A' %></p>
                            <p class="mb-2"><strong>Prestation:</strong> <%= surgery.prestation ? surgery.prestation.designation : 'N/A' %></p>
                            <% if (surgery.operatingRoom) { %>
                            <p class="mb-2">
                                <strong>Salle opératoire:</strong>
                                <a href="/operating-rooms/<%= surgery.operatingRoom._id %>" class="badge bg-light text-dark text-decoration-none">
                                    <i class="bi bi-hospital me-1"></i><%= surgery.operatingRoom.code %> - <%= surgery.operatingRoom.name %>
                                </a>
                                <% if (surgery.reservationStatus) { %>
                                    <% if (surgery.reservationStatus === 'confirmed') { %>
                                        <span class="badge bg-success ms-1">Confirmé</span>
                                    <% } else if (surgery.reservationStatus === 'reserved') { %>
                                        <span class="badge bg-primary ms-1">Réservé</span>
                                    <% } else if (surgery.reservationStatus === 'cancelled') { %>
                                        <span class="badge bg-danger ms-1">Annulé</span>
                                    <% } else if (surgery.reservationStatus === 'completed') { %>
                                        <span class="badge bg-secondary ms-1">Terminé</span>
                                    <% } %>
                                <% } %>
                            </p>
                            <% if (surgery.scheduledStartTime && surgery.scheduledEndTime) { %>
                            <p class="mb-2">
                                <strong>Créneau réservé:</strong>
                                <%= typeof moment !== 'undefined' ? moment(surgery.scheduledStartTime).format('DD/MM/YYYY HH:mm') : new Date(surgery.scheduledStartTime).toLocaleString('fr-FR') %>
                                -
                                <%= typeof moment !== 'undefined' ? moment(surgery.scheduledEndTime).format('HH:mm') : new Date(surgery.scheduledEndTime).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) %>
                            </p>
                            <% } %>
                            <% } %>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Statut:</strong>
                                <span class="badge status-badge <%= surgery.status === 'completed' ? 'bg-success' : surgery.status === 'urgent' ? 'status-urgent' : 'status-planned' %>">
                                    <%= surgery.status === 'completed' ? 'Terminée' : surgery.status === 'urgent' ? 'Urgente' : 'Planifiée' %>
                                </span>
                            </p>
                            <% if (surgery.asaClass) { %>
                            <p class="mb-2">
                                <strong>Classification ASA:</strong>
                                <span class="badge bg-info">
                                    <i class="bi bi-heart-pulse me-1"></i>
                                    ASA <%= surgery.asaClass %><%= surgery.asaUrgent ? ' U' : '' %>
                                </span>
                                <span class="text-muted small ms-2" data-bs-toggle="tooltip" title="<%= surgery.asaClass === 'I' ? 'Patient en bonne santé' : surgery.asaClass === 'II' ? 'Maladie systémique légère' : 'Maladie systémique grave' %>">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                            </p>
                            <% } %>
                            <p class="mb-2"><strong>Durée prévue:</strong> <%= surgery.prestation ? `${surgery.prestation.duration} min` : 'N/A' %></p>
                            <p class="mb-2"><strong>Durée réelle:</strong> <%= surgery.actualDuration ? `${surgery.actualDuration} min` : 'N/A' %></p>
                            <% if (canViewFinancialInfo) { %>
                            <p class="mb-2"><strong>Prix de base:</strong> <%= surgery.prestation ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.priceHT) : 'N/A' %></p>
                            <% } %>
                            <% if (surgery.statusLifecycle === 'closed') { %>
                                <p class="mb-2"><strong>État:</strong>
                                    <span class="badge bg-success">
                                        <i class="bi bi-lock-fill"></i> Clôturée
                                    </span>
                                </p>
                                <% if (surgery.closedAt) { %>
                                    <p class="mb-2"><strong>Clôturée le:</strong> <%= new Date(surgery.closedAt).toLocaleDateString('fr-FR') %> à <%= new Date(surgery.closedAt).toLocaleTimeString('fr-FR') %></p>
                                <% } %>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Surgical Timeline Card -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-hourglass-start me-2"></i>
                        Chronologie de l'Intervention
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="timeline-item mb-3">
                                    <h6 class="text-primary">
                                        <i class="fas fa-sign-in-alt me-2"></i>Entrée au Bloc
                                    </h6>
                                    <p class="mb-1">
                                        <strong><%= surgery.entreeBloc ? new Date(surgery.entreeBloc).toLocaleString('fr-FR') : 'Non enregistrée' %></strong>
                                    </p>
                                </div>

                                <div class="timeline-item mb-3">
                                    <h6 class="text-info">
                                        <i class="fas fa-door-open me-2"></i>Entrée en Salle d'Opération
                                    </h6>
                                    <p class="mb-1">
                                        <strong><%= surgery.entreeSalle ? new Date(surgery.entreeSalle).toLocaleString('fr-FR') : 'Non enregistrée' %></strong>
                                    </p>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="timeline-item mb-3">
                                    <h6 class="text-success">
                                        <i class="fas fa-cut me-2"></i>Heure d'Incision
                                    </h6>
                                    <p class="mb-1">
                                        <strong><%= surgery.incisionTime ? new Date(surgery.incisionTime).toLocaleString('fr-FR') : 'Non enregistrée' %></strong>
                                    </p>
                                </div>

                                <div class="timeline-item mb-3">
                                    <h6 class="text-danger">
                                        <i class="fas fa-stitches me-2"></i>Heure de Fermeture d'Incision
                                    </h6>
                                    <p class="mb-1">
                                        <strong><%= surgery.closingIncisionTime ? new Date(surgery.closingIncisionTime).toLocaleString('fr-FR') : 'Non enregistrée' %></strong>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <% if (surgery.sortieSalle) { %>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="timeline-item">
                                        <h6 class="text-secondary">
                                            <i class="fas fa-sign-out-alt me-2"></i>Sortie de Salle d'Opération
                                        </h6>
                                        <p class="mb-0">
                                            <strong><%= new Date(surgery.sortieSalle).toLocaleString('fr-FR') %></strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Material Consumption & Staff Participation -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-box me-2"></i>
                        Matériaux Consommés & Personnel Participant
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Materials Section -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-info mb-0">
                                    <i class="fas fa-box-open me-2"></i>
                                    Matériaux Utilisés
                                </h6>
                               
                            </div>
                            <% if (surgery.consumedMaterials && surgery.consumedMaterials.length > 0) { %>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover materials-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Matériau</th>
                                                <th>Catégorie</th>
                                                <th>Référence</th>
                                                <th>Quantité</th>
                                                <% if (canViewFinancialInfo) { %>
                                                <th>Prix unitaire</th>
                                                <th>Total</th>
                                                <% } %>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% surgery.consumedMaterials.forEach(cm => { %>
                                                <% 
                                                    // Get unit abbreviation for price display
                                                    const unitMap = {
                                                        'mètre (m)': 'm',
                                                        'litre (L)': 'L',
                                                        'millilitre (mL)': 'mL',
                                                        'gramme (g)': 'g',
                                                        'milligramme (mg)': 'mg',
                                                        'pièce (Pce)': 'pce',
                                                        'boîte (Bt)': 'bt',
                                                        'paquet (Paq)': 'paq',
                                                        'sachet (S)': 's',
                                                        'flacon (Fl)': 'fl',
                                                        'unité (U)': 'u'
                                                    };
                                                    const unitFull = cm.unitOfMeasure || (cm.material ? cm.material.unitOfMeasure : '') || 'unité (U)';
                                                    const unitAbbr = unitMap[unitFull] || unitFull;
                                                %>
                                                <tr>
                                                    <td><%= cm.material ? cm.material.designation : 'N/A' %></td>
                                                    <td>
                                                        <% if (cm.material && cm.material.category === 'patient') { %>
                                                            <span class="badge bg-primary">Patient</span>
                                                        <% } else { %>
                                                            <span class="badge bg-secondary">Consommable</span>
                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (cm.patientReference) { %>
                                                            <span class="badge bg-info text-dark" title="Référence/N° série du matériau">
                                                                <i class="bi bi-tag me-1"></i><%= cm.patientReference %>
                                                            </span>
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                    <td><%= cm.quantity %> <%= unitFull %></td>
                                                    <% if (canViewFinancialInfo) { %>
                                                    <td><%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(cm.priceUsed || 0) %>/<%= unitAbbr %></td>
                                                    <td><strong><%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format((cm.priceUsed || 0) * cm.quantity) %></strong></td>
                                                    <% } %>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                        <% if (canViewFinancialInfo) { %>
                                        <tfoot class="table-light">
                                            <tr class="fw-bold bg-light">
                                                <td colspan="3"><strong>Total Matériaux</strong></td>
                                                <td>
                                                    <% let totalQuantity = 0; %>
                                                    <% surgery.consumedMaterials?.forEach(cm => { totalQuantity += cm.quantity; }); %>
                                                    <%= totalQuantity %>
                                                </td>
                                                <td></td>
                                                <td class="text-end">
                                                    <strong>
                                                        <% const totalMaterialCost = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                            return sum + ((cm.priceUsed || 0) * cm.quantity);
                                                        }, 0); %>
                                                        <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(totalMaterialCost) %>
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr class="text-muted small">
                                                <td colspan="3"><em>↳ Matériaux patient</em></td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-end">
                                                    <% const patientMaterialsTotal = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                        return sum + (cm.material?.category === 'patient' ? (cm.priceUsed || 0) * cm.quantity : 0);
                                                    }, 0); %>
                                                    <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterialsTotal) %>
                                                </td>
                                            </tr>
                                            <tr class="text-muted small">
                                                <td colspan="3"><em>↳ Matériaux clinique</em></td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-end">
                                                    <% const clinicMaterialsTotal = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                        return sum + (cm.material?.category !== 'patient' ? (cm.priceUsed || 0) * cm.quantity : 0);
                                                    }, 0); %>
                                                    <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicMaterialsTotal) %>
                                                </td>
                                            </tr>
                                        </tfoot>
                                        <% } %>
                                    </table>
                                </div>
                            <% } else { %>
                                <p class="text-muted">Aucun matériau consommé</p>
                            <% } %>
                        </div>

                        <!-- Staff Section -->
                        <div class="col-md-6 mb-3">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-users me-2"></i>
                                Personnel Participant
                            </h6>
                            <% if (surgery.medicalStaff && surgery.medicalStaff.length > 0) { %>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover staff-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Personnel</th>
                                                <th>Rôle</th>
                                                <% if (canViewFinancialInfo) { %>
                                                <th>Tarif horaire</th>
                                                <% } %>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% surgery.medicalStaff.forEach(ms => { %>
                                                <tr>
                                                    <td>
                                                        <% if (ms.staff) { %>
                                                            <%= ms.staff.firstName %> <%= ms.staff.lastName %>
                                                        <% } else { %>
                                                            N/A
                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (ms.rolePlayedId && ms.rolePlayedId.name) { %>
                                                            <span class="badge bg-secondary"><%= ms.rolePlayedId.name %></span>
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                    <% if (canViewFinancialInfo) { %>
                                                    <td>
                                                        <% if (ms.staff && ms.staff.personalFee) { %>
                                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(ms.staff.personalFee) %>/h
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                    <% } %>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                        <% if (canViewFinancialInfo) { %>
                                        <tfoot class="table-light">
                                            <tr class="fw-bold bg-light">
                                                <td colspan="2"><strong>Total Frais Personnel</strong></td>
                                                <td class="text-end">
                                                    <strong>
                                                        <% const durationInHours = (surgery.actualDuration || 0) / 60; %>
                                                        <% const totalStaffCost = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                            return sum + ((s.staff?.personalFee || 0) * durationInHours);
                                                        }, 0); %>
                                                        <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(totalStaffCost) %>
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr class="text-muted small">
                                                <td colspan="2"><em>Durée: <%= durationInHours.toFixed(2) %> heures</em></td>
                                                <td class="text-end text-muted"></td>
                                            </tr>
                                        </tfoot>
                                        <% } %>
                                    </table>
                                </div>
                            <% } else { %>
                                <p class="text-muted">Aucun personnel enregistré</p>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <% if (canViewFinancialInfo) { %>
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        Explication des Calculs d'Honoraires
                    </h3>
                </div>
            </div>
            <% } %>

            <!-- Main Calculation Explanation -->
            <% if (canViewFinancialInfo) { %>
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Comment sont calculés les honoraires ?
                    </h4>
                </div>
                <div class="card-body">

                    <% if (!(surgery.surgeon && surgery.surgeon.contractType === 'location')) { %>
                    <!-- Base Calculation -->
                    <div class="row mb-4 calculation-step">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-1 me-2"></i>
                                1. Calcul de Base
                            </h5>
                            <div class="bg-light p-3 rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong>Prix de la prestation HT</strong>
                                        <br>
                                        <small class="text-muted">Prix utilisé pour cette chirurgie</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h5 text-primary">
                                            <% const basePrice = surgery.adjustedPrice || (surgery.prestation ? surgery.prestation.priceHT : 0); %>
                                            <% const urgentMultiplier = (surgery.status === 'urgent' && surgery.prestation) ? (1 + (surgery.prestation.urgentFeePercentage || 0)) : 1; %>
                                            <% const effectivePrice = basePrice * urgentMultiplier; %>
                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(effectivePrice) %>
                                        </span>
                                    </div>
                                </div>

                                <% if (surgery.adjustedPrice) { %>
                                <hr class="my-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-warning">Prix ajusté appliqué</strong>
                                        <br>
                                        <small class="text-muted">Prix spécifique utilisé pour cette chirurgie</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h5 text-warning">
                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.adjustedPrice) %>
                                        </span>
                                    </div>
                                </div>
                                <% } %>

                                <!-- Base Price -->
                                <hr class="my-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-info">Prix de base de la prestation</strong>
                                        <br>
                                        <small class="text-muted">Prix HT défini dans la prestation</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h5 text-info">
                                            <% if (surgery.prestation) { %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.priceHT) %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </span>
                                    </div>
                                </div>

                                <% if (surgery.status === 'urgent' && surgery.prestation && surgery.prestation.urgentFeePercentage > 0) { %>
                                <hr class="my-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-danger">+ Frais d'urgence (<%= (surgery.prestation.urgentFeePercentage * 100).toFixed(0) %>%)</strong>
                                        <br>
                                        <small class="text-muted">Majoration appliquée aux chirurgies urgentes</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h6 text-danger">
                                            <% const basePriceForUrgent = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                            <% const urgentFeeAmount = basePriceForUrgent * surgery.prestation.urgentFeePercentage; %>
                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(urgentFeeAmount) %>
                                        </span>
                                    </div>
                                </div>
                                <% } %>

                                <hr class="my-2">

                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-danger">- Matériaux patient</strong>
                                        <br>
                                        <small class="text-muted">Coût des matériaux utilisés pour le patient</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h6 text-danger">
                                            <% if (surgery.consumedMaterials) { %>
                                                <% const patientMaterials = surgery.consumedMaterials.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0); %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterials) %>
                                            <% } else { %>
                                                0,00 DA
                                            <% } %>
                                        </span>
                                    </div>
                                </div>

                                <hr class="my-2">

                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-success">= Base de calcul</strong>
                                        <br>
                                        <small class="text-muted">Montant utilisé pour répartir les honoraires</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h4 text-success">
                                            <% if (surgery.prestation) { %>
                                                <% const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                                <% const urgentMultiplier = surgery.status === 'urgent' ? (1 + (surgery.prestation.urgentFeePercentage || 0)) : 1; %>
                                                <% const effectivePrice = basePrice * urgentMultiplier; %>
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <% const baseAmount = effectivePrice - patientMaterials; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(baseAmount) %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- Surgeon Share: hidden for location contracts (clinic breakdown shown instead) -->
                    <% if (!(surgery.surgeon && surgery.surgeon.contractType === 'location')) { %>
                    <div class="row mb-4 calculation-step">
                            <div class="bg-light p-3 rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong>Part du chirurgien (<%= (surgery.surgeon.percentageRate || 45) %>%)</strong>
                                        <br>
                                        <small class="text-muted">((Prix effectif - Matériaux patient) × <%= (surgery.surgeon.percentageRate || 45) %>% - Frais dépassement</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h5 text-success">
                                            <% if (surgery.prestation) { %>
                                                <% const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                                <% const urgentRate = surgery.status === 'urgent' ? (surgery.prestation.urgentFeePercentage || 0) : 0; %>
                                                <% const effectivePrice = basePrice * (1 + urgentRate); %>
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <% const surgeonRate = (surgery.surgeon.percentageRate || 45) / 100; %>
                                                <% const surgeonBase = (effectivePrice - patientMaterials) * surgeonRate; %>
                                                <% 
                                                let extraFee = 0;
                                                if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                    const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                                                    const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                                                    const extraUnits = Math.ceil(extraDuration / durationUnit);
                                                    extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                                                }
                                                const surgeonShare = surgeonBase - extraFee;
                                                %>
                                                <%= !isNaN(surgeonShare) ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(Math.max(0, surgeonShare)) : 'N/A' %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </span>
                                    </div>
                                </div>

                                <% if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) { %>
                                    <% const extraDuration = surgery.actualDuration - surgery.prestation.duration; %>
                                    <% const tolerance = surgery.prestation.exceededDurationTolerance || 15; %>
                                    <% const billableExtraDuration = Math.max(0, extraDuration - tolerance); %>
                                    <% const durationUnit = surgery.prestation.exceededDurationUnit || 15; %>
                                    <% const extraUnits = billableExtraDuration > 0 ? Math.ceil(billableExtraDuration / durationUnit) : 0; %>
                                    <% const extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits; %>
                                    <% if (extraFee > 0) { %>
                                    <hr class="my-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-danger">- Frais dépassement appliqués</strong>
                                            <br>
                                            <small class="text-muted">Déduits du montant du chirurgien (après tolérance de <%= tolerance %> min)</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-danger">
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(extraFee) %>
                                            </span>
                                        </div>
                                    </div>
                                    <% } %>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- Extra Fees -->
                    <% if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) { %>
                        <% const extraDuration = surgery.actualDuration - surgery.prestation.duration; %>
                        <% const tolerance = surgery.prestation.exceededDurationTolerance || 15; %>
                        <% const billableExtraDuration = Math.max(0, extraDuration - tolerance); %>
                        <% const durationUnit = surgery.prestation.exceededDurationUnit || 15; %>
                        <% const extraUnits = billableExtraDuration > 0 ? Math.ceil(billableExtraDuration / durationUnit) : 0; %>
                        <% const extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits; %>
                        <div class="row mb-4 calculation-step">
                            <div class="col-12">
                                <h5 class="text-warning mb-3">
                                    <i class="fas fa-3 me-2"></i>
                                    3. Frais de Dépassement
                                </h5>
                                <div class="bg-light p-3 rounded">
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <strong>Durée prévue:</strong> <%= surgery.prestation.duration %> min
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Durée réelle:</strong> <%= surgery.actualDuration %> min
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <strong>Dépassement brut:</strong> <%= extraDuration %> min
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Marge de tolérance:</strong> <span class="badge bg-info"><%= tolerance %> min</span>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <strong>Dépassement facturable:</strong> <span class="text-primary"><%= billableExtraDuration %> min</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Unité de dépassement:</strong> <%= durationUnit %> min
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <strong>Unités facturées:</strong> <%= extraUnits %> unités
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Frais par unité:</strong> <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.exceededDurationFee || 0) %>
                                        </div>
                                    </div>
                                    <% if (extraFee > 0) { %>
                                    <hr class="my-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-warning">Frais dépassement appliqués</strong>
                                            <br>
                                            <small class="text-muted">
                                                <%= extraUnits %> unités à <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.exceededDurationFee || 0) %>
                                            </small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h5 text-warning">
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(extraFee) %>
                                            </span>
                                        </div>
                                    </div>
                                    <% } else { %>
                                    <hr class="my-2">
                                    <div class="alert alert-success mb-0">
                                        <i class="bi bi-check-circle me-2"></i>
                                        <strong>Aucun frais appliqué:</strong> Le dépassement est dans la marge de tolérance de <%= tolerance %> minutes.
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% } %>

                    <!-- Final Result (show clinic share instead of surgeon total) -->
                    <div class="row mb-4 calculation-step">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-4 me-2"></i>
                                4. Résultat Final – Part de la Clinique
                            </h5>
                            <div class="bg-primary bg-opacity-10 p-4 rounded text-center">
                                <h3 class="text-primary mb-2">Part de la Clinique</h3>
                                <div class="display-4 text-primary mb-2">
                                    <% if (surgery.prestation) { %>
                                        <% const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                        <% const urgentMultiplier = surgery.status === 'urgent' ? (1 + (surgery.prestation.urgentFeePercentage || 0)) : 1; %>
                                        <% const effectivePrice = basePrice * urgentMultiplier; %>
                                        <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                            return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                        }, 0) || 0; %>
                                        <%
                                        let clinicShare = 0;
                                        if (surgery.surgeon && surgery.surgeon.contractType === 'location') {
                                            // For location contracts: Clinic = (location Rate × Duration) + Materials (clinic + patient) + Personnel Fees (increased if urgent) + Overtime Fees + ASA Fee
                                            const locationRate = surgery.surgeon.locationRate || 0;
                                            const durationH = (surgery.actualDuration || 0) / 60;
                                            const locationCost = locationRate * durationH;
                                            const otherMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                return sum + (mat.material?.category !== 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                            }, 0) || 0;
                                            const personnelFees = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                return sum + ((s.staff?.personalFee || 0) * durationH);
                                            }, 0);
                                            const personnelFeesWithUrgent = personnelFees * urgentMultiplier;
                                            let extraFees = 0;
                                            if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                const extraduration = surgery.actualDuration - surgery.prestation.duration;
                                                const threshold = surgery.prestation.exceededDurationUnit || 15;
                                                if (extraduration >= threshold) {
                                                    extraFees = (surgery.prestation.exceededDurationFee || 0) * extraduration / threshold;
                                                }
                                            }
                                            const asaFee = (surgery.asaClass && surgery.asaPricing) ? (surgery.asaPricing.fee || 0) : 0;
                                            clinicShare = locationCost + patientMaterials + otherMaterials + personnelFeesWithUrgent + extraFees + asaFee;
                                        } else {
                                            // For percentage contracts, clinic gets percentage share
                                            const clinicRate = 1 - ((surgery.surgeon.percentageRate || 45) / 100);
                                            const clinicBase = (effectivePrice - patientMaterials) * clinicRate;
                                            let extraFee = 0;
                                            if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                                                const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                                                const extraUnits = Math.ceil(extraDuration / durationUnit);
                                                extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                                            }
                                            clinicShare = clinicBase + patientMaterials + extraFee;
                                        }
                                        %>
                                        <%= !isNaN(clinicShare) ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicShare) : 'N/A' %>
                                    <% } else { %>
                                        N/A
                                    <% } %>
                                </div>
                                <p class="text-muted mb-0">
                                    <strong>Formule:</strong>
                                    <% if (surgery.surgeon && surgery.surgeon.contractType === 'location') { %>
                                        Clinique = (Taux d'location × Durée) + Matériaux (clinique + patient) + Frais personnel (majorés si urgent) + Frais dépassement + Frais ASA
                                    <% } else { %>
                                        Clinique = ((Prix de base × (1 + Urgent%)) - Matériaux patient) × (1 - Taux chirurgien) + Matériaux patient + Frais dépassement
                                    <% } %>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Clinic Share -->
                    <div class="row calculation-step">
                        <div class="col-12">
                            <h5 class="text-info mb-3">
                                <i class="fas fa-5 me-2"></i>
                                <% if (surgery.surgeon && surgery.surgeon.contractType === 'location') { %>
                                    5. Revenus de la Clinique (location)
                                <% } else { %>
                                    5. Part de la Clinique (<%= 100 - (surgery.surgeon.percentageRate || 45) %>%)
                                <% } %>
                            </h5>
                            <div class="bg-light p-3 rounded">
                                <% if (surgery.surgeon && surgery.surgeon.contractType === 'location') { %>
                                    <% // Clinic breakdown for location contracts: locationCost + materials + personnel fees (with urgent uplift) + extraFees %>
                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <strong>Coût d'location (Durée × Taux d'location)</strong>
                                            <br>
                                            <small class="text-muted">Coût de la salle/opération supporté par la clinique</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-info">
                                                <% const durationInHours = (surgery.actualDuration || 0) / 60; %>
                                                <% const locationRate = surgery.surgeon?.locationRate || 0; %>
                                                <% const urgentUpliftForRate = surgery.status === 'urgent' && surgery.prestation ? locationRate * (surgery.prestation.urgentFeePercentage || 0) : 0; %>
                                                <% const effectivelocationRate = locationRate + urgentUpliftForRate; %>
                                                <% const locationCost = durationInHours * effectivelocationRate; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(locationCost) %>
                                            </span>
                                        </div>
                                    </div>

                                    <hr class="my-2">

                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <strong>Matériaux patient</strong>
                                            <br>
                                            <small class="text-muted">Coût des matériaux facturés au patient</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-info">
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterials) %>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <strong>Autres matériaux (clinique)</strong>
                                            <br>
                                            <small class="text-muted">Matériaux non facturés directement au patient</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-info">
                                                <% const otherMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category !== 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(otherMaterials) %>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <strong>Frais du personnel (horaire)</strong>
                                            <br>
                                            <small class="text-muted">Total des frais horaires du personnel (majoré si urgent)</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-info">
                                                <% const durationH = (surgery.actualDuration || 0) / 60; %>
                                                <% const personnelFees = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                    return sum + ((s.staff?.personalFee || 0) * durationH);
                                                }, 0); %>
                                                <% const personnelFeesWithUrgent = personnelFees * (surgery.status === 'urgent' ? (1 + (surgery.prestation?.urgentFeePercentage || 0)) : 1); %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(personnelFeesWithUrgent) %>
                                            </span>
                                        </div>
                                    </div>

                                    <% // Extra fees (dépassement) go to clinic %>
                                    <% let extraFees = 0; %>
                                    <% if (surgery.applyExtraFees && surgery.actualDuration > (surgery.prestation?.duration || 0)) { %>
                                        <% const extraduration = surgery.actualDuration - surgery.prestation.duration; %>
                                        <% const threshold = surgery.prestation.exceededDurationUnit || 15; %>
                                        <% if (extraduration >= threshold) { %>
                                            <% extraFees = (surgery.prestation.exceededDurationFee || 0) * extraduration / threshold; %>
                                            <hr class="my-2">
                                            <div class="row mb-2">
                                                <div class="col-md-8">
                                                    <strong>Frais de dépassement</strong>
                                                    <br>
                                                    <small class="text-muted">Frais additionnels facturés à la clinique</small>
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <span class="h6 text-info">
                                                        <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(extraFees) %>
                                                    </span>
                                                </div>
                                            </div>
                                        <% } %>
                                    <% } %>

                                    <% // ASA fees (only for location contracts with ASA class) %>
                                    <% let asaFeeAmount = 0; %>
                                    <% if (surgery.asaClass && surgery.asaPricing) { %>
                                        <% asaFeeAmount = surgery.asaPricing.fee || 0; %>
                                        <hr class="my-2">
                                        <div class="row mb-2">
                                            <div class="col-md-8">
                                                <strong>Frais ASA (Classe <%= surgery.asaClass %>)</strong>
                                                <br>
                                                <small class="text-muted">Frais forfaitaire payé par le chirurgien à la clinique</small>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <span class="h6 text-info">
                                                    <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(asaFeeAmount) %>
                                                </span>
                                            </div>
                                        </div>
                                    <% } %>

                                    <hr class="my-2">

                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-primary">= Total Clinique</strong>
                                            <br>
                                            <small class="text-muted">location + Matériaux + Personnel + Frais dépassement + Frais ASA</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h4 text-primary">
                                                <% const clinicTotal = locationCost + patientMaterials + otherMaterials + personnelFeesWithUrgent + (extraFees || 0) + asaFeeAmount; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicTotal) %>
                                            </span>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong>Part de la clinique (<%= 100 - (surgery.surgeon.percentageRate || 45) %>%)</strong>
                                            <br>
                                            <small class="text-muted">((Prix effectif - Matériaux patient) × <%= 100 - (surgery.surgeon.percentageRate || 45) %>% + Matériaux patient + Frais dépassement</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h5 text-info">
                                                <% if (surgery.prestation) { %>
                                                    <% const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                                    <% const urgentRate = surgery.status === 'urgent' ? (surgery.prestation.urgentFeePercentage || 0) : 0; %>
                                                    <% const effectivePrice = basePrice * (1 + urgentRate); %>
                                                    <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                        return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                    }, 0) || 0; %>
                                                    <% const clinicRate = 1 - ((surgery.surgeon.percentageRate || 45) / 100); %>
                                                    <% const clinicBase = (effectivePrice - patientMaterials) * clinicRate; %>
                                                    <% 
                                                    let extraFee = 0;
                                                    if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                        const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                                                        const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                                                        const extraUnits = Math.ceil(extraDuration / durationUnit);
                                                        extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                                                    }
                                                    const clinicShare = clinicBase + patientMaterials + extraFee;
                                                    %>
                                                    <%= !isNaN(clinicShare) ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicShare) : 'N/A' %>
                                                <% } else { %>
                                                    N/A
                                                <% } %>
                                            </span>
                                        </div>
                                    </div>
                                <% } %>

                                <hr class="my-2">

                                <% if (surgery.surgeon && surgery.surgeon.contractType === 'location') { %>
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-info">+ Matériaux patient</strong>
                                            <br>
                                            <small class="text-muted">Facturés au patient</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h5 text-info">
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterials) %>
                                            </span>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-info">+ Matériaux patient</strong>
                                            <br>
                                            <small class="text-muted">Facturés au patient mais inclus dans les revenus clinique</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h5 text-info">
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterials) %>
                                            </span>
                                        </div>
                                    </div>

                                    <% if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) { %>
                                        <% const extraDuration = surgery.actualDuration - surgery.prestation.duration; %>
                                        <% const durationUnit = surgery.prestation.exceededDurationUnit || 15; %>
                                        <% const extraUnits = Math.ceil(extraDuration / durationUnit); %>
                                        <% const extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits; %>
                                        <hr class="my-2">
                                        <div class="row align-items-center">
                                            <div class="col-md-8">
                                                <strong class="text-success">+ Frais dépassement appliqués</strong>
                                                <br>
                                                <small class="text-muted">Ajoutés au montant de la clinique</small>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <span class="h6 text-success">
                                                    <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(extraFee) %>
                                                </span>
                                            </div>
                                        </div>
                                    <% } %>
                                <% } %>
                                        </span>
                                    </div>
                                </div>

                                <hr class="my-2">

                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-primary">= Total Clinique</strong>
                                        <br>
                                        <small class="text-muted">Revenus totaux de la clinique</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h4 text-primary">
                                            <% if (surgery.prestation) { %>
                                                <%
                                                let finalClinicTotal = 0;
                                                if (surgery.surgeon && surgery.surgeon.contractType === 'location') {
                                                    // For location contracts, use the same calculation as above
                                                    const locationRate = surgery.surgeon.locationRate || 0;
                                                    const durationH = (surgery.actualDuration || 0) / 60;
                                                    const locationCost = locationRate * durationH;
                                                    const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                        return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                    }, 0) || 0;
                                                    const otherMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                        return sum + (mat.material?.category !== 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                    }, 0) || 0;
                                                    const personnelFees = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                        return sum + ((s.staff?.personalFee || 0) * durationH);
                                                    }, 0);
                                                    const urgentMultiplier = surgery.status === 'urgent' ? (1 + (surgery.prestation.urgentFeePercentage || 0)) : 1;
                                                    const personnelFeesWithUrgent = personnelFees * urgentMultiplier;
                                                    let extraFees = 0;
                                                    if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                        const extraduration = surgery.actualDuration - surgery.prestation.duration;
                                                        const threshold = surgery.prestation.exceededDurationUnit || 15;
                                                        if (extraduration >= threshold) {
                                                            extraFees = (surgery.prestation.exceededDurationFee || 0) * extraduration / threshold;
                                                        }
                                                    }
                                                    finalClinicTotal = locationCost + patientMaterials + otherMaterials + personnelFeesWithUrgent + extraFees;
                                                } else {
                                                    // For percentage contracts
                                                    const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT;
                                                    const urgentRate = surgery.status === 'urgent' ? (surgery.prestation.urgentFeePercentage || 0) : 0;
                                                    const effectivePrice = basePrice * (1 + urgentRate);
                                                    const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                        return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                    }, 0) || 0;
                                                    const clinicRate = 1 - ((surgery.surgeon.percentageRate || 45) / 100);
                                                    const clinicBase = (effectivePrice - patientMaterials) * clinicRate;
                                                    let extraFee = 0;
                                                    if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                        const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                                                        const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                                                        const extraUnits = Math.ceil(extraDuration / durationUnit);
                                                        extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                                                    }
                                                    finalClinicTotal = clinicBase + patientMaterials + extraFee;
                                                }
                                                %>
                                                <%= !isNaN(finalClinicTotal) ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(finalClinicTotal) : 'N/A' %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Summary Card -->
            <div class="card summary-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Résumé des Règles de Calcul
                    </h5>
                </div>
                <div class="card-body">
                    <% if (surgery.surgeon && surgery.surgeon.contractType === 'location') { %>
                        <div class="alert alert-info alert-custom">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>
                                Contrat d'location Horaire
                            </h6>
                            <ul class="mb-0">
                                <li><strong>Chirurgien:</strong> Reoit taux horaire effectif à durée réelle</li>
                                <li><strong>Taux effectif:</strong> Taux de base + frais urgents (si applicable)</li>
                                <li><strong>Clinique:</strong> Reoit prix HT effectif + matériaux patient + frais personnels</li>
                                <li><strong>Prix HT effectif:</strong> Prix ajusté à (1 + frais urgents) ou Prix de base à (1 + frais urgents)</li>
                                <li><strong>Matériaux patient:</strong> Facturés au patient</li>
                                <li><strong>Frais dépassement:</strong> Supportés par la clinique</li>
                            </ul>
                        </div>
                    <% } else { %>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success">Chirurgien reçoit:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check-circle text-success me-2"></i><%= (surgery.surgeon.percentageRate || 45) %>% du prix effectif (avec frais urgents inclus)</li>
                                    <li><i class="fas fa-check-circle text-success me-2"></i>Prix effectif = Prix de base à (1 + frais urgents)</li>
                                    <li><i class="fas fa-times-circle text-danger me-2"></i>Frais de dépassement déduits de son montant</li>
                                    <li><i class="fas fa-check-circle text-success me-2"></i>Taux fixe, pas de variation</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Clinique reçoit:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check-circle text-primary me-2"></i><%= 100 - (surgery.surgeon.percentageRate || 45) %>% du prix effectif (avec frais urgents inclus)</li>
                                    <li><i class="fas fa-x-circle text-muted me-2"></i><s>Frais personnels horaires</s> <small class="text-muted">(non appliqués)</small></li>
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>Frais urgents intégrés dans le calcul de base</li>
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>Matériaux cliniques</li>
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>100% des frais de dépassement</li>
                                </ul>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
            <% } %>

        </div>
    </div>
</div>

<!-- Add Materials Modal -->
<div class="modal fade" id="addMaterialsModal" tabindex="-1" aria-labelledby="addMaterialsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMaterialsModalLabel">
                    <i class="fas fa-plus me-2"></i>Ajouter des Matériaux à la Chirurgie
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addMaterialsForm" action="/surgeries/<%= surgery._id %>/add-materials" method="POST">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Sélectionnez les matériaux à ajouter et spécifiez les quantités. Les prix seront automatiquement calculés.
                    </div>
                    
                    <div id="materialsContainer">
                        <div class="material-row mb-3">
                            <div class="row align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label">Matériau</label>
                                    <select class="form-select material-select" name="materials[0][materialId]" required>
                                        <option value="">Sélectionner un matériau...</option>
                                        <% if (typeof materials !== 'undefined' && materials.length > 0) { %>
                                            <% materials.forEach(material => { %>
                                                <option value="<%= material._id %>" 
                                                        data-price="<%= material.weightedPrice || material.priceHT %>"
                                                        data-unit="<%= material.unitOfMeasure %>"
                                                        data-category="<%= material.category %>">
                                                    <%= material.designation %> (<%= material.category === 'patient' ? 'Patient' : 'Consommable' %>)
                                                </option>
                                            <% }); %>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Quantité</label>
                                    <input type="number" class="form-control quantity-input" name="materials[0][quantity]" min="0.01" step="0.01" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Prix unitaire</label>
                                    <input type="number" class="form-control unit-price-display" readonly>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-material-row">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addMaterialRow">
                        <i class="fas fa-plus me-1"></i>Ajouter un matériau
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Ajouter les Matériaux
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let materialRowIndex = 1;

function showAddMaterialsModal() {
    $('#addMaterialsModal').modal('show');
}

$(document).ready(function() {
    // Handle material selection change
    $(document).on('change', '.material-select', function() {
        const row = $(this).closest('.material-row');
        const selectedOption = $(this).find('option:selected');
        const price = selectedOption.data('price') || 0;
        const unit = selectedOption.data('unit') || '';
        
        row.find('.unit-price-display').val(price.toFixed(2));
        row.find('.quantity-input').attr('placeholder', unit);
    });
    
    // Add new material row
    $('#addMaterialRow').click(function() {
        const container = $('#materialsContainer');
        const newRow = `
            <div class="material-row mb-3">
                <div class="row align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Matériau</label>
                        <select class="form-select material-select" name="materials[${materialRowIndex}][materialId]" required>
                            <option value="">Sélectionner un matériau...</option>
                            <% if (typeof materials !== 'undefined' && materials.length > 0) { %>
                                <% materials.forEach(material => { %>
                                    <option value="<%= material._id %>" 
                                            data-price="<%= material.weightedPrice || material.priceHT %>"
                                            data-unit="<%= material.unitOfMeasure %>"
                                            data-category="<%= material.category %>">
                                        <%= material.designation %> (<%= material.category === 'patient' ? 'Patient' : 'Consommable' %>)
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quantité</label>
                        <input type="number" class="form-control quantity-input" name="materials[${materialRowIndex}][quantity]" min="0.01" step="0.01" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Prix unitaire</label>
                        <input type="number" class="form-control unit-price-display" readonly>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-material-row">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.append(newRow);
        materialRowIndex++;
    });
    
    // Remove material row
    $(document).on('click', '.remove-material-row', function() {
        const row = $(this).closest('.material-row');
        if ($('.material-row').length > 1) {
            row.remove();
        } else {
            alert('Vous devez avoir au moins un matériau.');
        }
    });
    
    // Form submission
    $('#addMaterialsForm').submit(function(e) {
        e.preventDefault();
        
        console.log('Form submission triggered');
        
        // Get all material rows
        const materialRows = $('.material-row');
        console.log('Material rows found:', materialRows.length);
        
        // Validate that at least one material is selected
        let hasValidMaterial = false;
        const materialsData = [];
        
        materialRows.each(function(index) {
            const materialId = $(this).find('.material-select').val();
            const quantity = $(this).find('.quantity-input').val();
            
            console.log(`Row ${index}: materialId=${materialId}, quantity=${quantity}`);
            
            if (materialId && quantity && quantity > 0) {
                hasValidMaterial = true;
                materialsData.push({
                    index,
                    materialId,
                    quantity
                });
            }
        });
        
        if (!hasValidMaterial) {
            alert('Veuillez sélectionner au moins un matériau avec une quantité valide.');
            return false;
        }
        
        console.log('Valid materials to submit:', materialsData);
        
        // Log form data for debugging
        console.log('Full form data:');
        const formData = new FormData(this);
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        // Submit the form
        this.submit();
    });
});
</script>
