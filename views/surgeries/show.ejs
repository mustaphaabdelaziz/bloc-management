<% layout('layouts/boilerplate') %>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <!-- Surgery Header with Actions -->
            <div class="card surgery-card mb-4">
                <div class="card-header bg-primary text-white surgery-header">
                    <div>
                        <h4 class="mb-0">
                            <i class="fas fa-clipboard me-2"></i>
                            Détails de la Chirurgie
                        </h4>
                        <small class="text-light">
                            Code: <%= surgery.code %> |
                            Patient: <%= surgery.patient ? `${surgery.patient.firstName} ${surgery.patient.lastName}` : 'N/A' %> |
                            Date: <%= new Date(surgery.beginDateTime).toLocaleDateString('fr-FR') %>
                        </small>
                    </div>
                    <div class="d-flex gap-2 ms-auto">
                        <a href="/surgeries/<%= surgery._id %>/edit" class="btn btn-light btn-sm" title="Modifier la chirurgie">
                            <i class="fas fa-edit me-1"></i>Modifier
                        </a>
                        <a href="/surgeries" class="btn btn-outline-light btn-sm" title="Retour à la liste">
                            <i class="fas fa-arrow-left me-1"></i>Retour
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Chirurgien:</strong> Dr. <%= surgery.surgeon ? `${surgery.surgeon.firstName} ${surgery.surgeon.lastName}` : 'N/A' %></p>
                            <p class="mb-2"><strong>Prestation:</strong> <%= surgery.prestation ? surgery.prestation.designation : 'N/A' %></p>
                            <p class="mb-2"><strong>Statut:</strong>
                                <span class="badge status-badge <%= surgery.status === 'completed' ? 'bg-success' : surgery.status === 'urgent' ? 'status-urgent' : 'status-planned' %>">
                                    <%= surgery.status === 'completed' ? 'Terminée' : surgery.status === 'urgent' ? 'Urgente' : 'Planifiée' %>
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Durée prévue:</strong> <%= surgery.prestation ? `${surgery.prestation.duration} min` : 'N/A' %></p>
                            <p class="mb-2"><strong>Durée réelle:</strong> <%= surgery.actualDuration ? `${surgery.actualDuration} min` : 'N/A' %></p>
                            <% if (canViewFinancialInfo) { %>
                            <p class="mb-2"><strong>Prix de base:</strong> <%= surgery.prestation ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.priceHT) : 'N/A' %></p>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Material Consumption & Staff Participation -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-box me-2"></i>
                        Matériaux Consommés & Personnel Participant
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Materials Section -->
                        <div class="col-md-6 mb-3">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-box-open me-2"></i>
                                Matériaux Utilisés
                            </h6>
                            <% if (surgery.consumedMaterials && surgery.consumedMaterials.length > 0) { %>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover materials-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Matériau</th>
                                                <th>Catégorie</th>
                                                <th>Quantité</th>
                                                <% if (canViewFinancialInfo) { %>
                                                <th>Prix unitaire</th>
                                                <th>Total</th>
                                                <% } %>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% surgery.consumedMaterials.forEach(cm => { %>
                                                <tr>
                                                    <td><%= cm.material ? cm.material.designation : 'N/A' %></td>
                                                    <td>
                                                        <% if (cm.material && cm.material.category === 'patient') { %>
                                                            <span class="badge bg-primary">Patient</span>
                                                        <% } else { %>
                                                            <span class="badge bg-secondary">Consommable</span>
                                                        <% } %>
                                                    </td>
                                                    <td><%= cm.quantity %> <%= cm.material ? cm.material.unitOfMeasure : '' %></td>
                                                    <% if (canViewFinancialInfo) { %>
                                                    <td><%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(cm.priceUsed || 0) %></td>
                                                    <td><strong><%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format((cm.priceUsed || 0) * cm.quantity) %></strong></td>
                                                    <% } %>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                        <% if (canViewFinancialInfo) { %>
                                        <tfoot class="table-light">
                                            <tr class="fw-bold bg-light">
                                                <td colspan="2"><strong>Total Matériaux</strong></td>
                                                <td>
                                                    <% let totalQuantity = 0; %>
                                                    <% surgery.consumedMaterials?.forEach(cm => { totalQuantity += cm.quantity; }); %>
                                                    <%= totalQuantity %>
                                                </td>
                                                <td></td>
                                                <td class="text-end">
                                                    <strong>
                                                        <% const totalMaterialCost = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                            return sum + ((cm.priceUsed || 0) * cm.quantity);
                                                        }, 0); %>
                                                        <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(totalMaterialCost) %>
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr class="text-muted small">
                                                <td colspan="2"><em>↳ Matériaux patient</em></td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-end">
                                                    <% const patientMaterialsTotal = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                        return sum + (cm.material?.category === 'patient' ? (cm.priceUsed || 0) * cm.quantity : 0);
                                                    }, 0); %>
                                                    <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterialsTotal) %>
                                                </td>
                                            </tr>
                                            <tr class="text-muted small">
                                                <td colspan="2"><em>↳ Matériaux clinique</em></td>
                                                <td></td>
                                                <td></td>
                                                <td class="text-end">
                                                    <% const clinicMaterialsTotal = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                        return sum + (cm.material?.category !== 'patient' ? (cm.priceUsed || 0) * cm.quantity : 0);
                                                    }, 0); %>
                                                    <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicMaterialsTotal) %>
                                                </td>
                                            </tr>
                                        </tfoot>
                                        <% } %>
                                    </table>
                                </div>
                            <% } else { %>
                                <p class="text-muted">Aucun matériau consommé</p>
                            <% } %>
                        </div>

                        <!-- Staff Section -->
                        <div class="col-md-6 mb-3">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-users me-2"></i>
                                Personnel Participant
                            </h6>
                            <% if (surgery.medicalStaff && surgery.medicalStaff.length > 0) { %>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover staff-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Personnel</th>
                                                <th>Rôle</th>
                                                <% if (canViewFinancialInfo) { %>
                                                <th>Tarif horaire</th>
                                                <% } %>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% surgery.medicalStaff.forEach(ms => { %>
                                                <tr>
                                                    <td>
                                                        <% if (ms.staff) { %>
                                                            <%= ms.staff.firstName %> <%= ms.staff.lastName %>
                                                        <% } else { %>
                                                            N/A
                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <% if (ms.rolePlayedId && ms.rolePlayedId.name) { %>
                                                            <span class="badge bg-secondary"><%= ms.rolePlayedId.name %></span>
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                    <% if (canViewFinancialInfo) { %>
                                                    <td>
                                                        <% if (ms.staff && ms.staff.personalFee) { %>
                                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(ms.staff.personalFee) %>/h
                                                        <% } else { %>
                                                            <span class="text-muted">-</span>
                                                        <% } %>
                                                    </td>
                                                    <% } %>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                        <% if (canViewFinancialInfo) { %>
                                        <tfoot class="table-light">
                                            <tr class="fw-bold bg-light">
                                                <td colspan="2"><strong>Total Frais Personnel</strong></td>
                                                <td class="text-end">
                                                    <strong>
                                                        <% const durationInHours = (surgery.actualDuration || 0) / 60; %>
                                                        <% const totalStaffCost = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                            return sum + ((s.staff?.personalFee || 0) * durationInHours);
                                                        }, 0); %>
                                                        <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(totalStaffCost) %>
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr class="text-muted small">
                                                <td colspan="2"><em>Durée: <%= durationInHours.toFixed(2) %> heures</em></td>
                                                <td class="text-end text-muted"></td>
                                            </tr>
                                        </tfoot>
                                        <% } %>
                                    </table>
                                </div>
                            <% } else { %>
                                <p class="text-muted">Aucun personnel enregistré</p>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <% if (canViewFinancialInfo) { %>
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        Explication des Calculs d'Honoraires
                    </h3>
                </div>
            </div>
            <% } %>

            <!-- Main Calculation Explanation -->
            <% if (canViewFinancialInfo) { %>
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Comment sont calculés les honoraires ?
                    </h4>
                </div>
                <div class="card-body">

                    <% if (!(surgery.surgeon && surgery.surgeon.contractType === 'allocation')) { %>
                    <!-- Base Calculation -->
                    <div class="row mb-4 calculation-step">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-1 me-2"></i>
                                1. Calcul de Base
                            </h5>
                            <div class="bg-light p-3 rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong>Prix de la prestation HT</strong>
                                        <br>
                                        <small class="text-muted">Prix utilisé pour cette chirurgie</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h5 text-primary">
                                            <% const basePrice = surgery.adjustedPrice || (surgery.prestation ? surgery.prestation.priceHT : 0); %>
                                            <% const urgentMultiplier = (surgery.status === 'urgent' && surgery.prestation) ? (1 + (surgery.prestation.urgentFeePercentage || 0)) : 1; %>
                                            <% const effectivePrice = basePrice * urgentMultiplier; %>
                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(effectivePrice) %>
                                        </span>
                                    </div>
                                </div>

                                <% if (surgery.adjustedPrice) { %>
                                <hr class="my-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-warning">Prix ajusté appliqué</strong>
                                        <br>
                                        <small class="text-muted">Prix spécifique utilisé pour cette chirurgie</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h5 text-warning">
                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.adjustedPrice) %>
                                        </span>
                                    </div>
                                </div>
                                <% } %>

                                <!-- Base Price -->
                                <hr class="my-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-info">Prix de base de la prestation</strong>
                                        <br>
                                        <small class="text-muted">Prix HT défini dans la prestation</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h5 text-info">
                                            <% if (surgery.prestation) { %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.priceHT) %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </span>
                                    </div>
                                </div>

                                <% if (surgery.status === 'urgent' && surgery.prestation && surgery.prestation.urgentFeePercentage > 0) { %>
                                <hr class="my-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-danger">+ Frais d'urgence (<%= (surgery.prestation.urgentFeePercentage * 100).toFixed(0) %>%)</strong>
                                        <br>
                                        <small class="text-muted">Majoration appliquée aux chirurgies urgentes</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h6 text-danger">
                                            <% const basePriceForUrgent = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                            <% const urgentFeeAmount = basePriceForUrgent * surgery.prestation.urgentFeePercentage; %>
                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(urgentFeeAmount) %>
                                        </span>
                                    </div>
                                </div>
                                <% } %>

                                <hr class="my-2">

                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-danger">− Matériaux patient</strong>
                                        <br>
                                        <small class="text-muted">Coût des matériaux utilisés pour le patient</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h6 text-danger">
                                            <% if (surgery.consumedMaterials) { %>
                                                <% const patientMaterials = surgery.consumedMaterials.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0); %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterials) %>
                                            <% } else { %>
                                                0,00 DA
                                            <% } %>
                                        </span>
                                    </div>
                                </div>

                                <hr class="my-2">

                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-success">= Base de calcul</strong>
                                        <br>
                                        <small class="text-muted">Montant utilisé pour répartir les honoraires</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h4 text-success">
                                            <% if (surgery.prestation) { %>
                                                <% const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                                <% const urgentMultiplier = surgery.status === 'urgent' ? (1 + (surgery.prestation.urgentFeePercentage || 0)) : 1; %>
                                                <% const effectivePrice = basePrice * urgentMultiplier; %>
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <% const baseAmount = effectivePrice - patientMaterials; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(baseAmount) %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- Surgeon Share: hidden for allocation contracts (clinic breakdown shown instead) -->
                    <% if (!(surgery.surgeon && surgery.surgeon.contractType === 'allocation')) { %>
                    <div class="row mb-4 calculation-step">
                            <div class="bg-light p-3 rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong>Part du chirurgien (<%= (surgery.surgeon.percentageRate || 45) %>%)</strong>
                                        <br>
                                        <small class="text-muted">((Prix effectif - Matériaux patient) × <%= (surgery.surgeon.percentageRate || 45) %>% - Frais dépassement</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h5 text-success">
                                            <% if (surgery.prestation) { %>
                                                <% const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                                <% const urgentRate = surgery.status === 'urgent' ? (surgery.prestation.urgentFeePercentage || 0) : 0; %>
                                                <% const effectivePrice = basePrice * (1 + urgentRate); %>
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <% const surgeonRate = (surgery.surgeon.percentageRate || 45) / 100; %>
                                                <% const surgeonBase = (effectivePrice - patientMaterials) * surgeonRate; %>
                                                <% 
                                                let extraFee = 0;
                                                if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                    const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                                                    const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                                                    const extraUnits = Math.ceil(extraDuration / durationUnit);
                                                    extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                                                }
                                                const surgeonShare = surgeonBase - extraFee;
                                                %>
                                                <%= !isNaN(surgeonShare) ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(Math.max(0, surgeonShare)) : 'N/A' %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </span>
                                    </div>
                                </div>

                                <% if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) { %>
                                    <% const extraDuration = surgery.actualDuration - surgery.prestation.duration; %>
                                    <% const durationUnit = surgery.prestation.exceededDurationUnit || 15; %>
                                    <% const extraUnits = Math.ceil(extraDuration / durationUnit); %>
                                    <% const extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits; %>
                                    <hr class="my-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-danger">− Frais dépassement appliqués</strong>
                                            <br>
                                            <small class="text-muted">Déduits du montant du chirurgien</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-danger">
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(extraFee) %>
                                            </span>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- Extra Fees -->
                    <% if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) { %>
                        <% const extraDuration = surgery.actualDuration - surgery.prestation.duration; %>
                        <% const durationUnit = surgery.prestation.exceededDurationUnit || 15; %>
                        <% const extraUnits = Math.ceil(extraDuration / durationUnit); %>
                        <% const extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits; %>
                        <div class="row mb-4 calculation-step">
                            <div class="col-12">
                                <h5 class="text-warning mb-3">
                                    <i class="fas fa-3 me-2"></i>
                                    3. Frais de Dépassement
                                </h5>
                                <div class="bg-light p-3 rounded">
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <strong>Durée prévue:</strong> <%= surgery.prestation.duration %> min
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Durée réelle:</strong> <%= surgery.actualDuration %> min
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <strong>Dépassement:</strong> <%= extraDuration %> min
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Unité de dépassement:</strong> <%= durationUnit %> min
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <strong>Unités de dépassement:</strong> <%= extraUnits %> unités
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Frais par unité:</strong> <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.exceededDurationFee || 0) %>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-warning">Frais dépassement appliqués</strong>
                                            <br>
                                            <small class="text-muted">
                                                <%= extraUnits %> unités × <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.exceededDurationFee || 0) %>
                                            </small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h5 text-warning">
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(extraFee) %>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% } %>

                    <!-- Final Result (show clinic share instead of surgeon total) -->
                    <div class="row mb-4 calculation-step">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-4 me-2"></i>
                                4. Résultat Final — Part de la Clinique
                            </h5>
                            <div class="bg-primary bg-opacity-10 p-4 rounded text-center">
                                <h3 class="text-primary mb-2">Part de la Clinique</h3>
                                <div class="display-4 text-primary mb-2">
                                    <% if (surgery.prestation) { %>
                                        <% const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                        <% const urgentMultiplier = surgery.status === 'urgent' ? (1 + (surgery.prestation.urgentFeePercentage || 0)) : 1; %>
                                        <% const effectivePrice = basePrice * urgentMultiplier; %>
                                        <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                            return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                        }, 0) || 0; %>
                                        <%
                                        let clinicShare = 0;
                                        if (surgery.surgeon && surgery.surgeon.contractType === 'allocation') {
                                            // For allocation contracts: Clinic = (Allocation Rate × Duration) + Materials (clinic + patient) + Personnel Fees (increased if urgent) + Overtime Fees
                                            const allocationRate = surgery.surgeon.allocationRate || 0;
                                            const durationH = (surgery.actualDuration || 0) / 60;
                                            const allocationCost = allocationRate * durationH;
                                            const otherMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                return sum + (mat.material?.category !== 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                            }, 0) || 0;
                                            const personnelFees = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                return sum + ((s.staff?.personalFee || 0) * durationH);
                                            }, 0);
                                            const personnelFeesWithUrgent = personnelFees * urgentMultiplier;
                                            let extraFees = 0;
                                            if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                const extraduration = surgery.actualDuration - surgery.prestation.duration;
                                                const threshold = surgery.prestation.exceededDurationUnit || 15;
                                                if (extraduration >= threshold) {
                                                    extraFees = (surgery.prestation.exceededDurationFee || 0) * extraduration / threshold;
                                                }
                                            }
                                            clinicShare = allocationCost + patientMaterials + otherMaterials + personnelFeesWithUrgent + extraFees;
                                        } else {
                                            // For percentage contracts, clinic gets percentage share
                                            const clinicRate = 1 - ((surgery.surgeon.percentageRate || 45) / 100);
                                            const clinicBase = (effectivePrice - patientMaterials) * clinicRate;
                                            let extraFee = 0;
                                            if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                                                const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                                                const extraUnits = Math.ceil(extraDuration / durationUnit);
                                                extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                                            }
                                            clinicShare = clinicBase + patientMaterials + extraFee;
                                        }
                                        %>
                                        <%= !isNaN(clinicShare) ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicShare) : 'N/A' %>
                                    <% } else { %>
                                        N/A
                                    <% } %>
                                </div>
                                <p class="text-muted mb-0">
                                    <strong>Formule:</strong>
                                    <% if (surgery.surgeon && surgery.surgeon.contractType === 'allocation') { %>
                                        Clinique = (Taux d'allocation × Durée) + Matériaux (clinique + patient) + Frais personnel (majorés si urgent) + Frais dépassement
                                    <% } else { %>
                                        Clinique = ((Prix de base × (1 + Urgent%)) − Matériaux patient) × (1 - Taux chirurgien) + Matériaux patient + Frais dépassement
                                    <% } %>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Clinic Share -->
                    <div class="row calculation-step">
                        <div class="col-12">
                            <h5 class="text-info mb-3">
                                <i class="fas fa-5 me-2"></i>
                                <% if (surgery.surgeon && surgery.surgeon.contractType === 'allocation') { %>
                                    5. Revenus de la Clinique (Allocation)
                                <% } else { %>
                                    5. Part de la Clinique (<%= 100 - (surgery.surgeon.percentageRate || 45) %>%)
                                <% } %>
                            </h5>
                            <div class="bg-light p-3 rounded">
                                <% if (surgery.surgeon && surgery.surgeon.contractType === 'allocation') { %>
                                    <% // Clinic breakdown for allocation contracts: allocationCost + materials + personnel fees (with urgent uplift) + extraFees %>
                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <strong>Coût d'allocation (Durée × Taux d'allocation)</strong>
                                            <br>
                                            <small class="text-muted">Coût de la salle/opération supporté par la clinique</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-info">
                                                <% const durationInHours = (surgery.actualDuration || 0) / 60; %>
                                                <% const allocationRate = surgery.surgeon?.allocationRate || 0; %>
                                                <% const urgentUpliftForRate = surgery.status === 'urgent' && surgery.prestation ? allocationRate * (surgery.prestation.urgentFeePercentage || 0) : 0; %>
                                                <% const effectiveAllocationRate = allocationRate + urgentUpliftForRate; %>
                                                <% const allocationCost = durationInHours * effectiveAllocationRate; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(allocationCost) %>
                                            </span>
                                        </div>
                                    </div>

                                    <hr class="my-2">

                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <strong>Matériaux patient</strong>
                                            <br>
                                            <small class="text-muted">Coût des matériaux facturés au patient</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-info">
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterials) %>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <strong>Autres matériaux (clinique)</strong>
                                            <br>
                                            <small class="text-muted">Matériaux non facturés directement au patient</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-info">
                                                <% const otherMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category !== 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(otherMaterials) %>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <strong>Frais du personnel (horaire)</strong>
                                            <br>
                                            <small class="text-muted">Total des frais horaires du personnel (majoré si urgent)</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h6 text-info">
                                                <% const durationH = (surgery.actualDuration || 0) / 60; %>
                                                <% const personnelFees = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                    return sum + ((s.staff?.personalFee || 0) * durationH);
                                                }, 0); %>
                                                <% const personnelFeesWithUrgent = personnelFees * (surgery.status === 'urgent' ? (1 + (surgery.prestation?.urgentFeePercentage || 0)) : 1); %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(personnelFeesWithUrgent) %>
                                            </span>
                                        </div>
                                    </div>

                                    <% // Extra fees (dépassement) go to clinic %>
                                    <% let extraFees = 0; %>
                                    <% if (surgery.applyExtraFees && surgery.actualDuration > (surgery.prestation?.duration || 0)) { %>
                                        <% const extraduration = surgery.actualDuration - surgery.prestation.duration; %>
                                        <% const threshold = surgery.prestation.exceededDurationUnit || 15; %>
                                        <% if (extraduration >= threshold) { %>
                                            <% extraFees = (surgery.prestation.exceededDurationFee || 0) * extraduration / threshold; %>
                                            <hr class="my-2">
                                            <div class="row mb-2">
                                                <div class="col-md-8">
                                                    <strong>Frais de dépassement</strong>
                                                    <br>
                                                    <small class="text-muted">Frais additionnels facturés à la clinique</small>
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <span class="h6 text-info">
                                                        <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(extraFees) %>
                                                    </span>
                                                </div>
                                            </div>
                                        <% } %>
                                    <% } %>

                                    <hr class="my-2">

                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-primary">= Total Clinique</strong>
                                            <br>
                                            <small class="text-muted">Allocation + Matériaux + Personnel + Frais dépassement</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h4 text-primary">
                                                <% const clinicTotal = allocationCost + patientMaterials + otherMaterials + personnelFeesWithUrgent + (extraFees || 0); %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicTotal) %>
                                            </span>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong>Part de la clinique (<%= 100 - (surgery.surgeon.percentageRate || 45) %>%)</strong>
                                            <br>
                                            <small class="text-muted">((Prix effectif - Matériaux patient) × <%= 100 - (surgery.surgeon.percentageRate || 45) %>% + Matériaux patient + Frais dépassement</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h5 text-info">
                                                <% if (surgery.prestation) { %>
                                                    <% const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT; %>
                                                    <% const urgentRate = surgery.status === 'urgent' ? (surgery.prestation.urgentFeePercentage || 0) : 0; %>
                                                    <% const effectivePrice = basePrice * (1 + urgentRate); %>
                                                    <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                        return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                    }, 0) || 0; %>
                                                    <% const clinicRate = 1 - ((surgery.surgeon.percentageRate || 45) / 100); %>
                                                    <% const clinicBase = (effectivePrice - patientMaterials) * clinicRate; %>
                                                    <% 
                                                    let extraFee = 0;
                                                    if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                        const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                                                        const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                                                        const extraUnits = Math.ceil(extraDuration / durationUnit);
                                                        extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                                                    }
                                                    const clinicShare = clinicBase + patientMaterials + extraFee;
                                                    %>
                                                    <%= !isNaN(clinicShare) ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicShare) : 'N/A' %>
                                                <% } else { %>
                                                    N/A
                                                <% } %>
                                            </span>
                                        </div>
                                    </div>
                                <% } %>

                                <hr class="my-2">

                                <% if (surgery.surgeon && surgery.surgeon.contractType === 'allocation') { %>
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-info">+ Matériaux patient</strong>
                                            <br>
                                            <small class="text-muted">Facturés au patient</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h5 text-info">
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterials) %>
                                            </span>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="text-info">+ Matériaux patient</strong>
                                            <br>
                                            <small class="text-muted">Facturés au patient mais inclus dans les revenus clinique</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="h5 text-info">
                                                <% const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                    return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                }, 0) || 0; %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterials) %>
                                            </span>
                                        </div>
                                    </div>

                                    <% if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) { %>
                                        <% const extraDuration = surgery.actualDuration - surgery.prestation.duration; %>
                                        <% const durationUnit = surgery.prestation.exceededDurationUnit || 15; %>
                                        <% const extraUnits = Math.ceil(extraDuration / durationUnit); %>
                                        <% const extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits; %>
                                        <hr class="my-2">
                                        <div class="row align-items-center">
                                            <div class="col-md-8">
                                                <strong class="text-success">+ Frais dépassement appliqués</strong>
                                                <br>
                                                <small class="text-muted">Ajoutés au montant de la clinique</small>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <span class="h6 text-success">
                                                    <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(extraFee) %>
                                                </span>
                                            </div>
                                        </div>
                                    <% } %>
                                <% } %>
                                        </span>
                                    </div>
                                </div>

                                <hr class="my-2">

                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <strong class="text-primary">= Total Clinique</strong>
                                        <br>
                                        <small class="text-muted">Revenus totaux de la clinique</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="h4 text-primary">
                                            <% if (surgery.prestation) { %>
                                                <%
                                                let finalClinicTotal = 0;
                                                if (surgery.surgeon && surgery.surgeon.contractType === 'allocation') {
                                                    // For allocation contracts, use the same calculation as above
                                                    const allocationRate = surgery.surgeon.allocationRate || 0;
                                                    const durationH = (surgery.actualDuration || 0) / 60;
                                                    const allocationCost = allocationRate * durationH;
                                                    const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                        return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                    }, 0) || 0;
                                                    const otherMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                        return sum + (mat.material?.category !== 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                    }, 0) || 0;
                                                    const personnelFees = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                        return sum + ((s.staff?.personalFee || 0) * durationH);
                                                    }, 0);
                                                    const urgentMultiplier = surgery.status === 'urgent' ? (1 + (surgery.prestation.urgentFeePercentage || 0)) : 1;
                                                    const personnelFeesWithUrgent = personnelFees * urgentMultiplier;
                                                    let extraFees = 0;
                                                    if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                        const extraduration = surgery.actualDuration - surgery.prestation.duration;
                                                        const threshold = surgery.prestation.exceededDurationUnit || 15;
                                                        if (extraduration >= threshold) {
                                                            extraFees = (surgery.prestation.exceededDurationFee || 0) * extraduration / threshold;
                                                        }
                                                    }
                                                    finalClinicTotal = allocationCost + patientMaterials + otherMaterials + personnelFeesWithUrgent + extraFees;
                                                } else {
                                                    // For percentage contracts
                                                    const basePrice = surgery.adjustedPrice || surgery.prestation.priceHT;
                                                    const urgentRate = surgery.status === 'urgent' ? (surgery.prestation.urgentFeePercentage || 0) : 0;
                                                    const effectivePrice = basePrice * (1 + urgentRate);
                                                    const patientMaterials = surgery.consumedMaterials?.reduce((sum, mat) => {
                                                        return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                                                    }, 0) || 0;
                                                    const clinicRate = 1 - ((surgery.surgeon.percentageRate || 45) / 100);
                                                    const clinicBase = (effectivePrice - patientMaterials) * clinicRate;
                                                    let extraFee = 0;
                                                    if (surgery.applyExtraFees && surgery.actualDuration > surgery.prestation.duration) {
                                                        const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                                                        const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                                                        const extraUnits = Math.ceil(extraDuration / durationUnit);
                                                        extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                                                    }
                                                    finalClinicTotal = clinicBase + patientMaterials + extraFee;
                                                }
                                                %>
                                                <%= !isNaN(finalClinicTotal) ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(finalClinicTotal) : 'N/A' %>
                                            <% } else { %>
                                                N/A
                                            <% } %>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Summary Card -->
            <div class="card summary-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Résumé des Règles de Calcul
                    </h5>
                </div>
                <div class="card-body">
                    <% if (surgery.surgeon && surgery.surgeon.contractType === 'allocation') { %>
                        <div class="alert alert-info alert-custom">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>
                                Contrat d'Allocation Horaire
                            </h6>
                            <ul class="mb-0">
                                <li><strong>Chirurgien:</strong> Reçoit taux horaire effectif × durée réelle</li>
                                <li><strong>Taux effectif:</strong> Taux de base + frais urgents (si applicable)</li>
                                <li><strong>Clinique:</strong> Reçoit prix HT effectif + matériaux patient + frais personnels</li>
                                <li><strong>Prix HT effectif:</strong> Prix ajusté × (1 + frais urgents) ou Prix de base × (1 + frais urgents)</li>
                                <li><strong>Matériaux patient:</strong> Facturés au patient</li>
                                <li><strong>Frais dépassement:</strong> Supportés par la clinique</li>
                            </ul>
                        </div>
                    <% } else { %>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success">Chirurgien reçoit:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check-circle text-success me-2"></i><%= (surgery.surgeon.percentageRate || 45) %>% du prix effectif (avec frais urgents inclus)</li>
                                    <li><i class="fas fa-check-circle text-success me-2"></i>Prix effectif = Prix de base × (1 + frais urgents)</li>
                                    <li><i class="fas fa-times-circle text-danger me-2"></i>Frais de dépassement déduits de son montant</li>
                                    <li><i class="fas fa-check-circle text-success me-2"></i>Taux fixe, pas de variation</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Clinique reçoit:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check-circle text-primary me-2"></i><%= 100 - (surgery.surgeon.percentageRate || 45) %>% du prix effectif (avec frais urgents inclus)</li>
                                    <li><i class="fas fa-x-circle text-muted me-2"></i><s>Frais personnels horaires</s> <small class="text-muted">(non appliqués)</small></li>
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>Frais urgents intégrés dans le calcul de base</li>
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>Matériaux cliniques</li>
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>100% des frais de dépassement</li>
                                </ul>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
            <% } %>

        </div>
    </div>
</div>
