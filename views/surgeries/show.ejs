<% layout('layouts/boilerplate') %>

<style>
/* Medical Theme Enhancements */
:root {
    --medical-primary: #007bff;
    --medical-secondary: #28a745;
    --medical-accent: #17a2b8;
    --medical-success: #198754;
    --medical-warning: #fd7e14;
    --medical-danger: #dc3545;
    --medical-info: #0dcaf0;
    --medical-light: #f8f9fa;
    --medical-dark: #212529;
    --medical-blue: #007bff;
    --medical-green: #28a745;
    --medical-gray: #6c757d;
}

.medical-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.medical-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
}

.medical-header {
    background: linear-gradient(135deg, var(--medical-blue) 0%, var(--medical-primary) 100%);
    color: white;
    border-radius: 15px 15px 0 0;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
}

.medical-header::before {
    content: 'üè•';
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 2rem;
    opacity: 0.3;
}

.timeline-item {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    border-left: 4px solid var(--medical-blue);
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    height: 100%;
}

.timeline-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-left-color: var(--medical-green);
}

/* Special styling for the exit item */
.timeline-item.bg-light {
    border-left-color: var(--medical-gray);
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
}

.timeline-item.bg-light:hover {
    border-left-color: var(--medical-secondary);
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.status-planned {
    background: linear-gradient(135deg, #6f42c1, #6610f2);
    color: white;
}

.status-urgent {
    background: linear-gradient(135deg, #fd7e14, #ff6b35);
    color: white;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(253, 126, 20, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(253, 126, 20, 0); }
    100% { box-shadow: 0 0 0 0 rgba(253, 126, 20, 0); }
}

.financial-highlight {
    background: linear-gradient(135deg, var(--medical-green), #20c997);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 2rem;
}

.medical-btn {
    border-radius: 25px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.medical-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.table-medical {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
}

.table-medical thead th {
    background: linear-gradient(135deg, var(--medical-blue), var(--medical-primary));
    color: white;
    border: none;
    padding: 1rem;
    font-weight: 600;
}

.table-medical tbody tr {
    transition: all 0.2s ease;
}

.table-medical tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

@media (max-width: 768px) {
    .medical-card {
        margin-bottom: 1rem;
    }

    .timeline-item {
        margin-left: 1rem;
        margin-right: 1rem;
    }

    .medical-header {
        padding: 1rem;
    }

    .medical-header h4 {
        font-size: 1.25rem;
    }
}
</style>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Surgery Header with Actions -->
            <div class="card medical-card mb-4">
                <div class="card-header medical-header">
                    <div>
                        <h4 class="mb-2">
                            <i class="fas fa-clipboard-check me-2"></i>
                            üè• D√©tails de la Chirurgie
                            <% if (surgery.statusLifecycle === 'closed') { %>
                                <span class="badge bg-success ms-2">
                                    <i class="bi bi-lock-fill"></i> üîí Cl√¥tur√©e
                                </span>
                            <% } %>
                        </h4>
                        <p class="mb-0 opacity-75">
                            <i class="fas fa-calendar-alt me-1"></i>
                            Suivi m√©dical complet de l'intervention
                        </p>
                    </div>
                    <div class="d-flex gap-2 ms-auto flex-wrap">
                        <% if (surgery.statusLifecycle !== 'closed' || permissions.canEditClosedSurgeries) { %>
                            <a href="/surgeries/<%= surgery._id %>/edit" class="btn btn-light medical-btn" title="Modifier la chirurgie">
                                <i class="fas fa-edit"></i>‚úèÔ∏è Modifier
                            </a>
                        <% } %>
                        <% if (permissions.canCloseSurgeries) { %>
                            <% if (surgery.statusLifecycle === 'editable') { %>
                                <form method="POST" action="/surgeries/<%= surgery._id %>/close" class="d-inline">
                                    <button type="submit" class="btn btn-primary medical-btn" onclick="return confirm('√ätes-vous s√ªr de vouloir cl√¥turer cette chirurgie? Elle ne pourra plus √™tre modifi√©e.')" title="Cl√¥turer la chirurgie">
                                        <i class="bi bi-lock-fill"></i>üîí Cl√¥turer
                                    </button>
                                </form>
                            <% } else if (surgery.statusLifecycle === 'closed') { %>
                                <form method="POST" action="/surgeries/<%= surgery._id %>/reopen" class="d-inline">
                                    <button type="submit" class="btn btn-warning medical-btn" onclick="return confirm('√ätes-vous s√ªr de vouloir rouvrir cette chirurgie?')" title="Rouvrir la chirurgie">
                                        <i class="bi bi-unlock-fill"></i>üîì Rouvrir
                                    </button>
                                </form>
                            <% } %>
                        <% } %>
                        <a href="/surgeries" class="btn btn-light text-dark medical-btn" title="Retour √† la liste">
                            <i class="fas fa-arrow-left"></i>‚¨ÖÔ∏è Retour
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="bg-light rounded-3 p-3 h-100">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-user-injured me-2"></i>üë§ Informations Patient
                                </h6>
                                <div class="mb-2">
                                    <strong class="text-muted">Code:</strong>
                                    <span class="badge bg-primary ms-2"><%= surgery.code %></span>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-muted">Patient:</strong>
                                    <span class="fw-bold"><%= surgery.patient ? `${surgery.patient.firstName} ${surgery.patient.lastName}` : 'N/A' %></span>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-muted">Chirurgien:</strong>
                                    <span class="fw-bold text-success">Dr. <%= surgery.surgeon ? `${surgery.surgeon.lastName} ${surgery.surgeon.firstName}` : 'N/A' %></span>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-muted">Prestation:</strong>
                                    <span class="fw-bold"><%= surgery.prestation ? surgery.prestation.designation : 'N/A' %></span>
                                </div>
                                <% if (surgery.operatingRoom) { %>
                                <div class="mb-2">
                                    <strong class="text-muted">Salle op√©ratoire:</strong>
                                    <a href="/operating-rooms/<%= surgery.operatingRoom._id %>" class="badge bg-light text-dark text-decoration-none ms-2">
                                        <i class="bi bi-hospital me-1"></i>üè• <%= surgery.operatingRoom.code %> - <%= surgery.operatingRoom.name %>
                                    </a>
                                    <% if (surgery.reservationStatus) { %>
                                        <% if (surgery.reservationStatus === 'confirmed') { %>
                                            <span class="badge bg-success ms-1">‚úÖ Confirm√©</span>
                                        <% } else if (surgery.reservationStatus === 'reserved') { %>
                                            <span class="badge bg-primary ms-1">üìÖ R√©serv√©</span>
                                        <% } else if (surgery.reservationStatus === 'cancelled') { %>
                                            <span class="badge bg-danger ms-1">‚ùå Annul√©</span>
                                        <% } else if (surgery.reservationStatus === 'completed') { %>
                                            <span class="badge bg-secondary ms-1">‚úÖ Termin√©</span>
                                        <% } %>
                                    <% } %>
                                </div>
                                <% if (surgery.scheduledStartTime && surgery.scheduledEndTime) { %>
                                <div class="mb-2">
                                    <strong class="text-muted">Cr√©neau r√©serv√©:</strong>
                                    <div class="mt-1">
                                        <i class="fas fa-clock me-1 text-info"></i>
                                        <%= typeof moment !== 'undefined' ? moment(surgery.scheduledStartTime).format('DD/MM/YYYY HH:mm') : new Date(surgery.scheduledStartTime).toLocaleString('fr-FR') %>
                                        <i class="fas fa-arrow-right mx-2 text-muted"></i>
                                        <%= typeof moment !== 'undefined' ? moment(surgery.scheduledEndTime).format('HH:mm') : new Date(surgery.scheduledEndTime).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) %>
                                    </div>
                                </div>
                                <% } %>
                                <% } %>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="bg-light rounded-3 p-3 h-100">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-stethoscope me-2"></i>ü©∫ Statut M√©dical
                                </h6>
                                <div class="mb-3">
                                    <strong class="text-muted">Statut:</strong>
                                    <span class="status-badge <%= surgery.status === 'completed' ? 'bg-success' : surgery.status === 'urgent' ? 'status-urgent' : 'status-planned' %> ms-2">
                                        <%= surgery.status === 'completed' ? '‚úÖ Termin√©e' : surgery.status === 'urgent' ? 'üö® Urgente' : 'üìã Planifi√©e' %>
                                    </span>
                                </div>
                                <% if (surgery.asaClass) { %>
                                <div class="mb-3">
                                    <strong class="text-muted">Classification ASA:</strong>
                                    <span class="badge bg-info ms-2 p-2">
                                        <i class="bi bi-heart-pulse me-1"></i>üíì ASA <%= surgery.asaClass %><%= surgery.asaUrgent ? ' U' : '' %>
                                    </span>
                                    <span class="text-muted small ms-2" data-bs-toggle="tooltip" title="<%= surgery.asaClass === 'I' ? 'Patient en bonne sant√©' : surgery.asaClass === 'II' ? 'Maladie syst√©mique l√©g√®re' : 'Maladie syst√©mique grave' %>">
                                        <i class="bi bi-info-circle"></i>
                                    </span>
                                </div>
                                <% } %>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-white rounded">
                                            <div class="text-muted small">Dur√©e pr√©vue</div>
                                            <div class="fw-bold text-primary">
                                                <i class="fas fa-clock me-1"></i>
                                                <%= surgery.prestation ? `${surgery.prestation.duration} min` : 'N/A' %>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-white rounded">
                                            <div class="text-muted small">Dur√©e r√©elle</div>
                                            <div class="fw-bold text-info">
                                                <i class="fas fa-stopwatch me-1"></i>
                                                <%= surgery.actualDuration ? `${surgery.actualDuration} min` : 'N/A' %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% if (canViewFinancialInfo) { %>
                                <div class="mt-3 p-2 bg-success bg-opacity-10 rounded">
                                    <strong class="text-muted">Prix de base:</strong>
                                    <span class="fw-bold text-success ms-2">
                                        <%= surgery.prestation ? new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(surgery.prestation.priceHT) : 'N/A' %>
                                    </span>
                                </div>
                                <% } %>
                                <% if (surgery.statusLifecycle === 'closed') { %>
                                <div class="mt-3 p-2 bg-warning bg-opacity-10 rounded">
                                    <strong class="text-muted">√âtat:</strong>
                                    <span class="badge bg-success ms-2">
                                        <i class="bi bi-lock-fill"></i> üîí Cl√¥tur√©e
                                    </span>
                                </div>
                                <% if (surgery.closedAt) { %>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-check me-1"></i>
                                        Cl√¥tur√©e le <%= new Date(surgery.closedAt).toLocaleDateString('fr-FR') %> √† <%= new Date(surgery.closedAt).toLocaleTimeString('fr-FR') %>
                                    </small>
                                </div>
                                <% } %>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Surgical Timeline Card -->
            <div class="card medical-card mb-4">
                <div class="card-header bg-warning text-dark d-flex align-items-center">
                    <i class="fas fa-hourglass-half me-2"></i>
                    <h5 class="mb-0">‚è∞ Chronologie de l'Intervention</h5>
                    <div class="ms-auto">
                        <small class="text-muted">Suivi temporel d√©taill√©</small>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- First Row: Entr√©e au Bloc & Entr√©e en Salle d'Op√©ration -->
                        <div class="col-md-6">
                            <div class="timeline-item">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-sign-in-alt"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-primary mb-1">üö™ Entr√©e au Bloc</h6>
                                        <small class="text-muted">D√©but de l'intervention</small>
                                    </div>
                                </div>
                                <p class="mb-0 fw-bold text-primary">
                                    <%= surgery.entreeBloc ? new Date(surgery.entreeBloc).toLocaleString('fr-FR') : '‚è≥ Non enregistr√©e' %>
                                </p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="timeline-item">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-door-open"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-info mb-1">üè• Entr√©e en Salle d'Op√©ration</h6>
                                        <small class="text-muted">Pr√©paration chirurgicale</small>
                                    </div>
                                </div>
                                <p class="mb-0 fw-bold text-info">
                                    <%= surgery.entreeSalle ? new Date(surgery.entreeSalle).toLocaleString('fr-FR') : '‚è≥ Non enregistr√©e' %>
                                </p>
                            </div>
                        </div>

                        <!-- Second Row: Heure d'Incision & Fermeture d'Incision -->
                        <div class="col-md-6">
                            <div class="timeline-item">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-cut"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-success mb-1">‚úÇÔ∏è Heure d'Incision</h6>
                                        <small class="text-muted">D√©but de l'acte chirurgical</small>
                                    </div>
                                </div>
                                <p class="mb-0 fw-bold text-success">
                                    <%= surgery.incisionTime ? new Date(surgery.incisionTime).toLocaleString('fr-FR') : '‚è≥ Non enregistr√©e' %>
                                </p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="timeline-item">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-stitches"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-danger mb-1">üßµ Fermeture d'Incision</h6>
                                        <small class="text-muted">Fin de l'acte chirurgical</small>
                                    </div>
                                </div>
                                <p class="mb-0 fw-bold text-danger">
                                    <%= surgery.closingIncisionTime ? new Date(surgery.closingIncisionTime).toLocaleString('fr-FR') : '‚è≥ Non enregistr√©e' %>
                                </p>
                            </div>
                        </div>

                        <!-- Third Row: Sortie de Salle d'Op√©ration (Full Width) -->
                        <% if (surgery.sortieSalle) { %>
                        <div class="col-12">
                            <div class="timeline-item text-center bg-light">
                                <div class="d-flex align-items-center justify-content-center mb-2">
                                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-sign-out-alt"></i>
                                    </div>
                                    <div class="text-start">
                                        <h6 class="text-secondary mb-1">üö∂ Sortie de Salle d'Op√©ration</h6>
                                        <small class="text-muted">Fin de l'intervention</small>
                                    </div>
                                </div>
                                <p class="mb-0 fw-bold text-secondary">
                                    <%= new Date(surgery.sortieSalle).toLocaleString('fr-FR') %>
                                </p>
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Material Consumption & Staff Participation -->
            <div class="card medical-card mb-4">
                <div class="card-header bg-info text-white d-flex align-items-center">
                    <i class="fas fa-boxes me-2"></i>
                    <h5 class="mb-0">üì¶ Mat√©riaux Consomm√©s & üë• Personnel Participant</h5>
                    <div class="ms-auto">
                        <small class="opacity-75">Gestion des ressources m√©dicales</small>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Materials Section -->
                        <div class="col-lg-6">
                            <div class="bg-light rounded-3 p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-info mb-0">
                                        <i class="fas fa-box-open me-2"></i>ü©π Mat√©riaux Utilis√©s
                                    </h6>
                                    <% if (surgery.statusLifecycle !== 'closed' && canViewFinancialInfo) { %>
                                        <button type="button" class="btn btn-sm btn-outline-primary medical-btn" data-bs-toggle="modal" data-bs-target="#addMaterialsModal" title="Ajouter des mat√©riaux">
                                            <i class="fas fa-plus"></i>‚ûï Ajouter
                                        </button>
                                    <% } %>
                                </div>
                                <% if (surgery.consumedMaterials && surgery.consumedMaterials.length > 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover table-medical">
                                            <thead>
                                                <tr>
                                                    <th><i class="fas fa-tag me-1"></i>Mat√©riau</th>
                                                    <th><i class="fas fa-layer-group me-1"></i>Cat√©gorie</th>
                                                    <th><i class="fas fa-hashtag me-1"></i>R√©f√©rence</th>
                                                    <th><i class="fas fa-weight me-1"></i>Quantit√©</th>
                                                    <% if (canViewFinancialInfo) { %>
                                                    <th><i class="fas fa-tag me-1"></i>Prix U.</th>
                                                    <th><i class="fas fa-calculator me-1"></i>Total</th>
                                                    <% } %>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% surgery.consumedMaterials.forEach(cm => { %>
                                                    <% 
                                                        // Get unit abbreviation for price display
                                                        const unitMap = {
                                                            'm√®tre (m)': 'm',
                                                            'litre (L)': 'L',
                                                            'millilitre (mL)': 'mL',
                                                            'gramme (g)': 'g',
                                                            'milligramme (mg)': 'mg',
                                                            'pi√®ce (Pce)': 'pce',
                                                            'bo√Æte (Bt)': 'bt',
                                                            'paquet (Paq)': 'paq',
                                                            'sachet (S)': 's',
                                                            'flacon (Fl)': 'fl',
                                                            'unit√© (U)': 'u'
                                                        };
                                                        const unitFull = cm.unitOfMeasure || (cm.material ? cm.material.unitOfMeasure : '') || 'unit√© (U)';
                                                        const unitAbbr = unitMap[unitFull] || unitFull;
                                                    %>
                                                    <tr>
                                                        <td>
                                                            <strong><%= cm.material ? cm.material.designation : 'N/A' %></strong>
                                                        </td>
                                                        <td>
                                                            <% if (cm.material && cm.material.category === 'patient') { %>
                                                                <span class="badge bg-primary">üë§ Patient</span>
                                                            <% } else { %>
                                                                <span class="badge bg-secondary">üîß Consommable</span>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <% if (cm.patientReference) { %>
                                                                <span class="badge bg-info text-dark" title="R√©f√©rence/N¬∞ s√©rie du mat√©riau">
                                                                    <i class="bi bi-tag me-1"></i><%= cm.patientReference %>
                                                                </span>
                                                            <% } else { %>
                                                                <span class="text-muted">-</span>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold"><%= cm.quantity %></span> <%= unitFull %>
                                                        </td>
                                                        <% if (canViewFinancialInfo) { %>
                                                        <td><%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(cm.priceUsed || 0) %>/<%= unitAbbr %></td>
                                                        <td><strong><%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format((cm.priceUsed || 0) * cm.quantity) %></strong></td>
                                                        <% } %>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                            <% if (canViewFinancialInfo) { %>
                                            <tfoot class="table-light">
                                                <tr class="fw-bold">
                                                    <td colspan="3"><strong>üìä Total Mat√©riaux</strong></td>
                                                    <td>
                                                        <% let totalQuantity = 0; %>
                                                        <% surgery.consumedMaterials?.forEach(cm => { totalQuantity += cm.quantity; }); %>
                                                        <strong><%= totalQuantity %></strong>
                                                    </td>
                                                    <td></td>
                                                    <td class="text-end">
                                                        <strong class="text-primary">
                                                            <% const totalMaterialCost = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                                return sum + ((cm.priceUsed || 0) * cm.quantity);
                                                            }, 0); %>
                                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(totalMaterialCost) %>
                                                        </strong>
                                                    </td>
                                                </tr>
                                                <tr class="text-muted small">
                                                    <td colspan="3"><em>‚Ü≥ üè• Mat√©riaux patient</em></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td class="text-end">
                                                        <% const patientMaterialsTotal = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                            return sum + (cm.material?.category === 'patient' ? (cm.priceUsed || 0) * cm.quantity : 0);
                                                        }, 0); %>
                                                        <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(patientMaterialsTotal) %>
                                                    </td>
                                                </tr>
                                                <tr class="text-muted small">
                                                    <td colspan="3"><em>‚Ü≥ üè• Mat√©riaux clinique</em></td>
                                                    <td></td>
                                                    <td></td>
                                                    <td class="text-end">
                                                        <% const clinicMaterialsTotal = (surgery.consumedMaterials || []).reduce((sum, cm) => {
                                                            return sum + (cm.material?.category !== 'patient' ? (cm.priceUsed || 0) * cm.quantity : 0);
                                                        }, 0); %>
                                                        <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(clinicMaterialsTotal) %>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                            <% } %>
                                        </table>
                                    </div>
                                <% } else { %>
                                    <div class="text-center py-4">
                                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">üì≠ Aucun mat√©riau consomm√©</p>
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- Staff Section -->
                        <div class="col-lg-6">
                            <div class="bg-light rounded-3 p-3 h-100">
                                <h6 class="text-info mb-3">
                                    <i class="fas fa-users me-2"></i>üë®‚Äç‚öïÔ∏è Personnel Participant
                                </h6>
                                <% if (surgery.medicalStaff && surgery.medicalStaff.length > 0) { %>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover table-medical">
                                            <thead>
                                                <tr>
                                                    <th><i class="fas fa-user-md me-1"></i>Personnel</th>
                                                    <th><i class="fas fa-user-tag me-1"></i>R√¥le</th>
                                                    <% if (canViewFinancialInfo) { %>
                                                    <th><i class="fas fa-clock me-1"></i>Tarif/h</th>
                                                    <% } %>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% surgery.medicalStaff.forEach(ms => { %>
                                                    <tr>
                                                        <td>
                                                            <% if (ms.staff) { %>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 0.8rem;">
                                                                        <%= ms.staff.firstName.charAt(0) %><%= ms.staff.lastName.charAt(0) %>
                                                                    </div>
                                                                    <div>
                                                                        <strong><%= ms.staff.firstName %> <%= ms.staff.lastName %></strong>
                                                                    </div>
                                                                </div>
                                                            <% } else { %>
                                                                <span class="text-muted">N/A</span>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <% if (ms.rolePlayedId && ms.rolePlayedId.name) { %>
                                                                <span class="badge bg-secondary"><%= ms.rolePlayedId.name %></span>
                                                            <% } else { %>
                                                                <span class="text-muted">-</span>
                                                            <% } %>
                                                        </td>
                                                        <% if (canViewFinancialInfo) { %>
                                                        <td>
                                                            <% if (ms.staff && ms.staff.personalFee) { %>
                                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(ms.staff.personalFee) %>/h
                                                            <% } else { %>
                                                                <span class="text-muted">-</span>
                                                            <% } %>
                                                        </td>
                                                        <% } %>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                            <% if (canViewFinancialInfo) { %>
                                            <tfoot class="table-light">
                                                <tr class="fw-bold">
                                                    <td colspan="2"><strong>üí∞ Total Frais Personnel</strong></td>
                                                    <td class="text-end">
                                                        <strong class="text-success">
                                                            <% const durationInHours = (surgery.actualDuration || 0) / 60; %>
                                                            <% const totalStaffCost = (surgery.medicalStaff || []).reduce((sum, s) => {
                                                                return sum + ((s.staff?.personalFee || 0) * durationInHours);
                                                            }, 0); %>
                                                            <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(totalStaffCost) %>
                                                        </strong>
                                                    </td>
                                                </tr>
                                                <tr class="text-muted small">
                                                    <td colspan="2"><em>‚è±Ô∏è Dur√©e: <%= durationInHours.toFixed(2) %> heures</em></td>
                                                    <td class="text-end text-muted"></td>
                                                </tr>
                                            </tfoot>
                                            <% } %>
                                        </table>
                                    </div>
                                <% } else { %>
                                    <div class="text-center py-4">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">üë• Aucun personnel enregistr√©</p>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom Fees Section -->
            <% if (canViewFinancialInfo) { %>
            <div class="card medical-card mb-4">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-tag me-2"></i>
                        <h5 class="mb-0">üí∞ Frais Personnalis√©s</h5>
                    </div>
                    <% if (surgery.statusLifecycle !== 'closed') { %>
                        <button type="button" class="btn btn-sm btn-outline-primary medical-btn" data-bs-toggle="modal" data-bs-target="#addCustomFeesModal" title="Ajouter des frais personnalis√©s">
                            <i class="fas fa-plus"></i>‚ûï Ajouter Frais
                        </button>
                    <% } %>
                </div>
                <div class="card-body">
                    <% if (surgery.customFees && surgery.customFees.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-medical">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-file-invoice me-1"></i>Nom du Frais</th>
                                        <th><i class="fas fa-coins me-1"></i>Montant</th>
                                        <th><i class="fas fa-calendar-alt me-1"></i>Date</th>
                                        <% if (surgery.statusLifecycle !== 'closed') { %>
                                        <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                        <% } %>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% surgery.customFees.forEach((fee, index) => { %>
                                        <tr>
                                            <td>
                                                <strong><%= fee.feeName %></strong>
                                                <small class="text-muted d-block">Frais suppl√©mentaire</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-warning text-dark p-2">
                                                    <i class="fas fa-coins me-1"></i>
                                                    <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(fee.feeAmount) %>
                                                </span>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar-check me-1"></i>
                                                    <%= new Date(fee.createdAt).toLocaleDateString('fr-FR') %>
                                                </small>
                                            </td>
                                            <% if (surgery.statusLifecycle !== 'closed') { %>
                                            <td>
                                                <form method="POST" action="/surgeries/<%= surgery._id %>/custom-fees/<%= index %>?_method=DELETE" style="display:inline;">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger medical-btn" onclick="return confirm('‚ö†Ô∏è CONFIRMATION DE SUPPRESSION\n\nVous √™tes sur le point de supprimer le frais personnalis√© :\n‚Ä¢ <%= fee.description %>\n‚Ä¢ Montant : <%= fee.amount %> ‚Ç¨\n\nCette action est irr√©versible.\n\nConfirmer la suppression ?')" title="Supprimer le frais">
                                                        <i class="fas fa-trash"></i>üóëÔ∏è
                                                    </button>
                                                </form>
                                            </td>
                                            <% } %>
                                        </tr>
                                    <% }); %>
                                </tbody>
                                <tfoot class="table-light">
                                    <tr class="fw-bold">
                                        <td><strong>üìä Total Frais Personnalis√©s</strong></td>
                                        <td colspan="<%= surgery.statusLifecycle !== 'closed' ? '3' : '2' %>" class="text-end">
                                            <strong class="text-warning">
                                                <% const totalCustomFees = (surgery.customFees || []).reduce((sum, fee) => sum + (fee.feeAmount || 0), 0); %>
                                                <%= new Intl.NumberFormat('fr-DZ', { style: 'currency', currency: 'DZD' }).format(totalCustomFees) %>
                                            </strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-tag fa-3x text-muted mb-3"></i>
                            <p class="text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                üíº Aucun frais personnalis√© ajout√© pour cette chirurgie
                            </p>
                        </div>
                    <% } %>
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>üí° Note:</strong> Les frais personnalis√©s sont d√©duits du montant du chirurgien lors du calcul final des honoraires.
                        </small>
                    </div>
                </div>
            </div>
            <% } %>


            <!-- Financial Calculation Display -->
            <% if (canViewFinancialInfo) { %>
            <div class="card medical-card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-calculator me-2"></i>
                        <h4 class="mb-0">üí∞ R√©partition Financi√®re</h4>
                        <small class="opacity-75">Analyse d√©taill√©e des co√ªts et revenus</small>
                    </div>
                    <a href="/surgeries/<%= surgery._id %>/export/financial-excel" class="btn btn-light medical-btn">
                        <i class="fas fa-file-excel"></i>üìä Exporter en Excel
                    </a>
                </div>
                <div class="card-body">

                    <% 
                    // Calculate all components for display
                    const basePrice = surgery.adjustedPrice || (surgery.prestation ? surgery.prestation.priceHT : 0);
                    const urgentRate = (surgery.status === 'urgent' && surgery.prestation) ? (surgery.prestation.urgentFeePercentage || 0) : 0;
                    const effectivePrice = basePrice * (1 + urgentRate);
                    const patientMaterials = (surgery.consumedMaterials || []).reduce((sum, mat) => {
                        return sum + (mat.material?.category === 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                    }, 0);
                    const otherMaterials = (surgery.consumedMaterials || []).reduce((sum, mat) => {
                        return sum + (mat.material?.category !== 'patient' ? (mat.priceUsed || 0) * mat.quantity : 0);
                    }, 0);
                    const durationH = (surgery.actualDuration || 0) / 60;
                    const personnelFees = (surgery.medicalStaff || []).reduce((sum, s) => {
                        return sum + ((s.staff?.personalFee || 0) * durationH);
                    }, 0);
                    const customFeeTotal = (surgery.customFees || []).reduce((sum, fee) => sum + (fee.feeAmount || 0), 0);
                    
                    // Calculate extra fees with tolerance
                    let extraFee = 0;
                    if (surgery.applyExtraFees && surgery.actualDuration > (surgery.prestation?.duration || 0)) {
                        const extraDuration = surgery.actualDuration - surgery.prestation.duration;
                        const tolerance = surgery.prestation.exceededDurationTolerance || 15;
                        const billableExtraDuration = Math.max(0, extraDuration - tolerance);
                        if (billableExtraDuration > 0) {
                            const durationUnit = surgery.prestation.exceededDurationUnit || 15;
                            const extraUnits = Math.ceil(billableExtraDuration / durationUnit);
                            extraFee = (surgery.prestation.exceededDurationFee || 0) * extraUnits;
                        }
                    }
                    
                    const isLocationContract = surgery.surgeon && surgery.surgeon.contractType === 'location';
                    %>

                    <% if (!isLocationContract) { %>
                    <!-- SURGEON SECTION (Percentage Contract) -->
                    <div class="mb-4">
                        <div class="card border-success medical-card">
                            <div class="card-header bg-success text-white d-flex align-items-center">
                                <i class="fas fa-user-md me-2"></i>
                                <h5 class="mb-0">üë®‚Äç‚öïÔ∏è Part du Chirurgien</h5>
                                <div class="ms-auto">
                                    <small class="badge bg-light text-success">Contrat Pourcentage</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="financial-highlight mb-4">
                                    <h2 class="display-4 text-white mb-0 fw-bold">
                                        <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(surgery.surgeonAmount || 0) %> DA
                                    </h2>
                                    <small class="text-white-50">üíº Montant total du chirurgien</small>
                                </div>

                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-chart-line me-2"></i>üìà D√©tail du calcul:
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered table-medical">
                                        <tbody>
                                            <tr class="bg-light">
                                                <td class="fw-bold">
                                                    <i class="fas fa-euro-sign me-2 text-success"></i>Prix effectif
                                                    <br><small class="text-muted">Prix de base <%= urgentRate > 0 ? '√ó (1 + ' + (urgentRate * 100).toFixed(0) + '% urgence)' : '' %></small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(effectivePrice) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-danger">
                                                    <i class="fas fa-minus me-2"></i>‚àí Mat√©riaux patient
                                                    <br><small class="text-muted">Exclus du calcul chirurgien</small>
                                                </td>
                                                <td class="text-end fw-bold text-danger">
                                                    ‚àí <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(patientMaterials) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold">
                                                    <i class="fas fa-percentage me-2 text-info"></i>√ó Taux chirurgien
                                                    <br><small class="text-muted"><%= (surgery.surgeon?.percentageRate || 45) %>% de la base</small>
                                                </td>
                                                <td class="text-end fw-bold text-info">
                                                    <% const surgeonBase = (effectivePrice - patientMaterials) * ((surgery.surgeon?.percentageRate || 45) / 100); %>
                                                    <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(surgeonBase) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-danger">
                                                    <i class="fas fa-clock me-2"></i>‚àí Frais d√©passement
                                                    <br><small class="text-muted">D√©duits du chirurgien (apr√®s tol√©rance)</small>
                                                </td>
                                                <td class="text-end fw-bold text-danger">
                                                    ‚àí <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(extraFee) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-danger">
                                                    <i class="fas fa-tag me-2"></i>‚àí Frais personnalis√©s
                                                    <br><small class="text-muted">D√©duits du chirurgien</small>
                                                </td>
                                                <td class="text-end fw-bold text-danger">
                                                    ‚àí <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(customFeeTotal) %> DA
                                                </td>
                                            </tr>
                                            <tr class="table-success fw-bold">
                                                <td class="bg-success text-white">
                                                    <i class="fas fa-equals me-2"></i>= TOTAL CHIRURGIEN
                                                </td>
                                                <td class="text-end bg-success text-white">
                                                    <strong><%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(surgery.surgeonAmount || 0) %> DA</strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } else { %>
                    <!-- SURGEON SECTION (Location Contract) - Shows 0 -->
                    <div class="mb-4">
                        <div class="card border-secondary medical-card">
                            <div class="card-header bg-secondary text-white d-flex align-items-center">
                                <i class="fas fa-user-md me-2"></i>
                                <h5 class="mb-0">üë®‚Äç‚öïÔ∏è Part du Chirurgien (Contrat Location)</h5>
                                <div class="ms-auto">
                                    <small class="badge bg-light text-secondary">Contrat Location</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="financial-highlight mb-4" style="background: linear-gradient(135deg, var(--medical-gray), #6c757d);">
                                    <h2 class="display-4 text-white mb-0 fw-bold">
                                        <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(0) %> DA
                                    </h2>
                                    <small class="text-white-50">üè• Le chirurgien ne re√ßoit pas de part (contrat location)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- CLINIC SECTION -->
                    <div class="mb-4">
                        <div class="card border-info medical-card">
                            <div class="card-header bg-info text-white d-flex align-items-center">
                                <i class="fas fa-hospital me-2"></i>
                                <h5 class="mb-0">üè• Part de la Clinique</h5>
                                <div class="ms-auto">
                                    <small class="badge bg-light text-info">Revenus cliniques</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="financial-highlight mb-4" style="background: linear-gradient(135deg, var(--medical-blue), var(--medical-primary));">
                                    <h2 class="display-4 text-white mb-0 fw-bold">
                                        <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(surgery.clinicAmount || 0) %> DA
                                    </h2>
                                    <small class="text-white-50">üíº Montant total de la clinique</small>
                                </div>

                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-chart-pie me-2"></i>üìä D√©tail du calcul:
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered table-medical">
                                        <tbody>
                                            <% if (isLocationContract) { %>
                                            <!-- Location Contract Breakdown -->
                                            <tr class="bg-light">
                                                <td class="fw-bold">
                                                    <i class="fas fa-euro-sign me-2 text-primary"></i>Co√ªt location (horaire)
                                                    <br><small class="text-muted">Taux: <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(surgery.surgeon?.locationRate || 0) %> DA/h √ó <%= durationH.toFixed(2) %> h <%= urgentRate > 0 ? '√ó (1 + ' + (urgentRate * 100).toFixed(0) + '%)' : '' %></small>
                                                </td>
                                                <td class="text-end fw-bold text-primary">
                                                    <% const locationCost = (surgery.surgeon?.locationRate || 0) * durationH * (1 + urgentRate); %>
                                                    <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(locationCost) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Mat√©riaux patient
                                                    <br><small class="text-muted">Factur√©s au patient</small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(patientMaterials) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Mat√©riaux clinique
                                                    <br><small class="text-muted">Consommables non-patient</small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(otherMaterials) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Frais personnel
                                                    <br><small class="text-muted">Tarif horaire √ó <%= durationH.toFixed(2) %> h <%= urgentRate > 0 ? '√ó (1 + ' + (urgentRate * 100).toFixed(0) + '%)' : '' %></small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    <% const personnelFeesWithUrgent = personnelFees * (1 + urgentRate); %>
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(personnelFeesWithUrgent) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Frais d√©passement
                                                    <br><small class="text-muted">Ajout√©s √† la clinique</small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(extraFee) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Frais ASA
                                                    <br><small class="text-muted"><%= surgery.asaClass ? 'Classe ASA ' + surgery.asaClass : 'Non applicable' %></small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    <% const asaFee = (surgery.asaClass && surgery.asaPricing) ? (surgery.asaPricing.fee || 0) : 0; %>
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(asaFee) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Frais personnalis√©s
                                                    <br><small class="text-muted">Ajout√©s √† la clinique</small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(customFeeTotal) %> DA
                                                </td>
                                            </tr>
                                            <% } else { %>
                                            <!-- Percentage Contract Breakdown -->
                                            <tr class="bg-light">
                                                <td class="fw-bold">
                                                    <i class="fas fa-percentage me-2 text-info"></i>Part pourcentage clinique
                                                    <br><small class="text-muted"><%= 100 - (surgery.surgeon?.percentageRate || 45) %>% √ó (Prix effectif ‚àí Mat√©riaux patient)</small>
                                                </td>
                                                <td class="text-end fw-bold text-info">
                                                    <% const clinicBase = (effectivePrice - patientMaterials) * (1 - ((surgery.surgeon?.percentageRate || 45) / 100)); %>
                                                    <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(clinicBase) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Mat√©riaux patient
                                                    <br><small class="text-muted">Ajout√©s apr√®s r√©partition</small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(patientMaterials) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Frais d√©passement
                                                    <br><small class="text-muted">Ajout√©s √† la clinique</small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(extraFee) %> DA
                                                </td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td class="fw-bold text-success">
                                                    <i class="fas fa-plus me-2"></i>+ Frais personnalis√©s
                                                    <br><small class="text-muted">Ajout√©s √† la clinique</small>
                                                </td>
                                                <td class="text-end fw-bold text-success">
                                                    + <%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(customFeeTotal) %> DA
                                                </td>
                                            </tr>
                                            <% } %>
                                            <tr class="table-info fw-bold">
                                                <td class="bg-info text-white">
                                                    <i class="fas fa-equals me-2"></i>= TOTAL CLINIQUE
                                                </td>
                                                <td class="text-end bg-info text-white">
                                                    <strong><%= new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(surgery.clinicAmount || 0) %> DA</strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <% } %>

        </div>
    </div>
</div>

<!-- Add Materials Modal -->
<div class="modal fade" id="addMaterialsModal" tabindex="-1" aria-labelledby="addMaterialsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content medical-card">
            <div class="modal-header medical-header">
                <h5 class="modal-title" id="addMaterialsModalLabel">
                    <i class="fas fa-plus me-2"></i>‚ûï Ajouter des Mat√©riaux √† la Chirurgie
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addMaterialsForm" action="/surgeries/<%= surgery._id %>/add-materials" method="POST">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        S√©lectionnez les mat√©riaux √† ajouter et sp√©cifiez les quantit√©s. Les prix seront automatiquement calcul√©s.
                    </div>
                    
                    <div id="materialsContainer">
                        <div class="material-row mb-3">
                            <div class="row align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label">Mat√©riau</label>
                                    <select class="form-select material-select" name="materials[0][materialId]" required>
                                        <option value="">S√©lectionner un mat√©riau...</option>
                                        <% if (typeof materials !== 'undefined' && materials.length > 0) { %>
                                            <% materials.forEach(material => { %>
                                                <option value="<%= material._id %>" 
                                                        data-price="<%= material.weightedPrice || material.priceHT %>"
                                                        data-unit="<%= material.unitOfMeasure %>"
                                                        data-category="<%= material.category %>">
                                                    <%= material.designation %> (<%= material.category === 'patient' ? 'Patient' : 'Consommable' %>)
                                                </option>
                                            <% }); %>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Quantit√©</label>
                                    <input type="number" class="form-control quantity-input" name="materials[0][quantity]" min="0.01" step="0.01" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Prix unitaire</label>
                                    <input type="number" class="form-control unit-price-display" readonly>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-material-row">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addMaterialRow">
                        <i class="fas fa-plus me-1"></i>Ajouter un mat√©riau
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Ajouter les Mat√©riaux
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let materialRowIndex = 1;

function showAddMaterialsModal() {
    $('#addMaterialsModal').modal('show');
}

$(document).ready(function() {
    // Handle material selection change
    $(document).on('change', '.material-select', function() {
        const row = $(this).closest('.material-row');
        const selectedOption = $(this).find('option:selected');
        const price = selectedOption.data('price') || 0;
        const unit = selectedOption.data('unit') || '';
        
        row.find('.unit-price-display').val(price.toFixed(2));
        row.find('.quantity-input').attr('placeholder', unit);
    });
    
    // Add new material row
    $('#addMaterialRow').click(function() {
        const container = $('#materialsContainer');
        const newRow = `
            <div class="material-row mb-3">
                <div class="row align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Mat√©riau</label>
                        <select class="form-select material-select" name="materials[${materialRowIndex}][materialId]" required>
                            <option value="">S√©lectionner un mat√©riau...</option>
                            <% if (typeof materials !== 'undefined' && materials.length > 0) { %>
                                <% materials.forEach(material => { %>
                                    <option value="<%= material._id %>" 
                                            data-price="<%= material.weightedPrice || material.priceHT %>"
                                            data-unit="<%= material.unitOfMeasure %>"
                                            data-category="<%= material.category %>">
                                        <%= material.designation %> (<%= material.category === 'patient' ? 'Patient' : 'Consommable' %>)
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quantit√©</label>
                        <input type="number" class="form-control quantity-input" name="materials[${materialRowIndex}][quantity]" min="0.01" step="0.01" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Prix unitaire</label>
                        <input type="number" class="form-control unit-price-display" readonly>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-material-row">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.append(newRow);
        materialRowIndex++;
    });
    
    // Remove material row
    $(document).on('click', '.remove-material-row', function() {
        const row = $(this).closest('.material-row');
        if ($('.material-row').length > 1) {
            row.remove();
        } else {
            alert('Vous devez avoir au moins un mat√©riau.');
        }
    });
    
    // Form submission
    $('#addMaterialsForm').submit(function(e) {
        e.preventDefault();
        
        console.log('Form submission triggered');
        
        // Get all material rows
        const materialRows = $('.material-row');
        console.log('Material rows found:', materialRows.length);
        
        // Validate that at least one material is selected
        let hasValidMaterial = false;
        const materialsData = [];
        
        materialRows.each(function(index) {
            const materialId = $(this).find('.material-select').val();
            const quantity = $(this).find('.quantity-input').val();
            
            console.log(`Row ${index}: materialId=${materialId}, quantity=${quantity}`);
            
            if (materialId && quantity && quantity > 0) {
                hasValidMaterial = true;
                materialsData.push({
                    index,
                    materialId,
                    quantity
                });
            }
        });
        
        if (!hasValidMaterial) {
            alert('Veuillez s√©lectionner au moins un mat√©riau avec une quantit√© valide.');
            return false;
        }
        
        console.log('Valid materials to submit:', materialsData);
        
        // Log form data for debugging
        console.log('Full form data:');
        const formData = new FormData(this);
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        // Submit the form
        this.submit();
    });
});
</script>

<!-- Add Custom Fees Modal -->
<div class="modal fade" id="addCustomFeesModal" tabindex="-1" aria-labelledby="addCustomFeesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content medical-card">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="addCustomFeesModalLabel">
                    <i class="fas fa-plus me-2"></i>üí∞ Ajouter des Frais Personnalis√©s
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCustomFeesForm" action="/surgeries/<%= surgery._id %>/add-custom-fees" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Exemple:</strong> OVERNIGHT STAY, Location de mat√©riel sp√©cialis√©, etc.
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Ces frais seront d√©duits du montant du chirurgien lors du calcul des honoraires.
                    </div>
                    
                    <div id="feesContainer">
                        <div class="fee-row mb-3">
                            <div class="row align-items-end">
                                <div class="col-md-7">
                                    <label class="form-label">Nom du Frais</label>
                                    <input type="text" class="form-control fee-name" name="fees[0][feeName]" placeholder="Ex: OVERNIGHT STAY, Mat√©riel sp√©cialis√©..." required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Montant (DA)</label>
                                    <input type="number" class="form-control fee-amount" name="fees[0][feeAmount]" min="0" step="0.01" placeholder="0,00" required>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-fee-row" disabled>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-warning btn-sm" id="addFeeRow">
                        <i class="fas fa-plus me-1"></i>Ajouter un autre frais
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-1"></i>Ajouter les Frais
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let feeRowIndex = 1;

$(document).ready(function() {
    // Add new fee row
    $('#addFeeRow').click(function() {
        const container = $('#feesContainer');
        const newRow = `
            <div class="fee-row mb-3">
                <div class="row align-items-end">
                    <div class="col-md-7">
                        <label class="form-label">Nom du Frais</label>
                        <input type="text" class="form-control fee-name" name="fees[${feeRowIndex}][feeName]" placeholder="Ex: OVERNIGHT STAY, Mat√©riel sp√©cialis√©..." required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Montant (DA)</label>
                        <input type="number" class="form-control fee-amount" name="fees[${feeRowIndex}][feeAmount]" min="0" step="0.01" placeholder="0,00" required>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-fee-row">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.append(newRow);
        updateRemoveButtons();
        feeRowIndex++;
    });
    
    // Update remove button states
    function updateRemoveButtons() {
        const rows = $('.fee-row').length;
        $('.remove-fee-row').prop('disabled', rows <= 1);
    }
    
    // Remove fee row
    $(document).on('click', '.remove-fee-row', function() {
        const row = $(this).closest('.fee-row');
        if ($('.fee-row').length > 1) {
            row.remove();
            updateRemoveButtons();
        }
    });
    
    // Form submission
    $('#addCustomFeesForm').submit(function(e) {
        e.preventDefault();
        
        // Get all fee rows
        const feeRows = $('.fee-row');
        let hasValidFee = false;
        const feesData = [];
        
        feeRows.each(function(index) {
            const feeName = $(this).find('.fee-name').val().trim();
            const feeAmount = parseFloat($(this).find('.fee-amount').val()) || 0;
            
            if (feeName && feeAmount > 0) {
                hasValidFee = true;
                feesData.push({
                    index,
                    feeName,
                    feeAmount
                });
            }
        });
        
        if (!hasValidFee) {
            alert('Veuillez ajouter au moins un frais avec un nom et un montant valide.');
            return false;
        }
        
        // Submit the form
        this.submit();
    });
});
</script>

