# Auto-Code Generation System

This document describes the automatic code generation system implemented for Fonction, Prestation, and Surgery entities.

## Overview

All three entities now have automatically generated codes following predefined patterns. Users don't need to manually enter codes in the forms—they are generated automatically upon entity creation.

## Patterns

### 1. **Fonction (Function) Code**
- **Pattern:** `FCT` + 4-digit sequential number
- **Examples:** `FCT0001`, `FCT0002`, `FCT0003`
- **Format:** Always starts with "FCT" followed by zero-padded number
- **Counter:** Global counter (counts all fonctions)

### 2. **Prestation (Service/Procedure) Code**
- **Pattern:** `CO-` + Specialty Code + `-` + 4-digit sequential number
- **Examples:** `CO-ORT-0001`, `CO-CAR-0002`, `CO-URO-0001`
- **Format:** CO (constant) - Specialty Code (3 chars) - Sequential Number
- **Counter:** Per-specialty counter (resets for each specialty)
- **Specialty Codes:** Defined in Specialty entity (e.g., ORT=Orthopédie, CAR=Cardiologie)

### 3. **Surgery Code**
- **Pattern:** `YYYY/XXXXX` where YYYY is current year
- **Examples:** `2025/00001`, `2025/00002`, `2024/00001`
- **Format:** Year (4 digits) - Slash - Sequential Number (5 digits)
- **Counter:** Per-year counter (resets on January 1st each year)
- **Advantage:** Easy historical tracking by year

## Implementation

### Database Models

**Fonction.js**
```javascript
// Auto-generated in pre-save hook
// Counts total fonctions and generates next code
```

**Prestation.js**
```javascript
// Auto-generated in pre-save hook
// Populates specialty to get its code
// Counts prestations for this specialty
```

**Surgery.js**
```javascript
// Auto-generated in pre-save hook
// Counts surgeries created in current year
// Based on createdAt timestamp
```

### Form Views

All code input fields have been removed from forms:

- **views/fonctions/new.ejs** - Code field removed
- **views/fonctions/edit.ejs** - Code field set to readonly (display only)
- **views/prestations/new.ejs** - Code field removed (specialty selection shown)
- **views/prestations/edit.ejs** - Code field set to readonly (display only)
- **views/surgeries/new.ejs** - No code field (auto-generated on save)
- **views/surgeries/edit.ejs** - No code field (auto-generated on save)

### Controllers

**fonction.controller.js**
- Removed manual code handling
- Code auto-generated by model pre-save hook

**prestation.controller.js**
- Removed code validation from create
- Removed code from update data (cannot be changed)
- Code auto-generated based on selected specialty

**surgery.controller.js**
- No changes needed (code never handled)
- Code auto-generated by model pre-save hook

## Code Generation Flow

### When Creating a New Fonction
1. User fills form with only: Name, Description
2. User submits form
3. Model `pre('save')` hook executes:
   - Checks if code is empty
   - Counts existing fonctions
   - Generates new code: `FCT000X`
4. Document saved with auto-generated code

### When Creating a New Prestation
1. User fills form with: Specialty, Designation, Price, Duration, etc.
2. Specialty is required
3. User submits form
4. Model `pre('save')` hook executes:
   - Populates specialty to get its code
   - Counts prestations for this specialty
   - Generates new code: `CO-{specialtyCode}-0001`
5. Document saved with auto-generated code

### When Creating a New Surgery
1. User selects: Patient, Surgeon, Prestation, Dates, etc.
2. User submits form (no code field)
3. Model `pre('save')` hook executes:
   - Gets current year from createdAt
   - Counts surgeries created this year
   - Generates new code: `2025/00001`
4. Document saved with auto-generated code

## Editing Existing Records

- **Fonction:** Code shown as readonly (cannot modify)
- **Prestation:** Code shown as readonly (cannot modify)
- **Surgery:** Code never shown in form (read-only by design)

This prevents accidental code changes which could break references.

## Unique Constraints

All codes have MongoDB unique indexes to prevent duplicates:
- Fonction.code: Unique globally
- Prestation.code: Unique globally
- Surgery.code: Unique globally

## Benefits

1. **No Manual Entry:** Users don't need to remember or create codes
2. **Consistency:** Codes follow strict patterns
3. **Auto-Increment:** Sequential numbering prevents conflicts
4. **Year-Based Surgery Tracking:** Easy to identify surgeries by year
5. **Specialty-Based Prestation Tracking:** Easy to group prestations by specialty
6. **Data Integrity:** Readonly codes prevent modification errors

## Error Handling

If code generation fails:
- Fonction: Generic error message
- Prestation: Error if specialty not found
- Surgery: Generic error message

All errors are caught and displayed to user with appropriate messages.

## Migration for Existing Data

If migrating from old codes:
1. Backup existing data
2. Keep old codes if needed (add a separate field)
3. New records will use new auto-generation system
4. Old records keep their original codes

## Utility Functions

Helper functions are available in `utils/codeGenerator.js`:
- `generateFonctionCode(count)`
- `generatePrestationCode(specialtyCode, count)`
- `generateSurgeryCode(year, count)`

These can be used in reports or other features.
